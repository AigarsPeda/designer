import{d as ye,r as R,b as Ie,f as D,o as Me,c as Ce,a as Te,_ as Le,e as We,h as Ee,g as V,i as Ue,j as $e,s as qe,u as Fe,k as He,w as Ze,l as ze,m as Ve,n as Ne}from"./index-ed4b0528.js";const Ke=({canvas:e,containerRef:t})=>{const o=(t==null?void 0:t.offsetWidth)||500,n=(t==null?void 0:t.offsetHeight)||500;e==null||e.setDimensions({width:o,height:n})},Qe=({canvas:e})=>{e.on("mouse:wheel",t=>{const o=t.e.deltaY;let n=e.getZoom();n*=.999**o,n>20&&(n=20),n<.01&&(n=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},n),t.e.preventDefault(),t.e.stopPropagation()})},Ge=ye({__name:"FabricCanvas",props:{id:{}},emits:["canvas-created","mouse-down","mouse-dblclick","selection-created","selection-cleared","selection-updated"],setup(e,{emit:t}){const o=R(null),n=R(null),r=R({width:0,height:0}),s=R(null);return Ie(()=>{var l,f,u,j;const i=new D.fabric.Canvas(s.value,{preserveObjectStacking:!0,width:((l=n.value)==null?void 0:l.offsetWidth)||500,height:((f=n.value)==null?void 0:f.offsetHeight)||500});i&&(o.value=i,t("canvas-created",i),i.on("selection:created",a=>{t("selection-created",a)}),i.on("selection:updated",a=>{t("selection-updated",a)}),i.on("selection:cleared",a=>{t("selection-cleared",a)}),i.on("mouse:dblclick",a=>{t("mouse-dblclick",a)}),i.on("mouse:down:before",a=>{t("mouse-down",a)}),i.on("object:modified",a=>{var b;(b=a.target)==null||b.set({opacity:1}),i.renderAll()}),i.on("object:moving",a=>{var b;(b=a.target)==null||b.set({opacity:.75}),i.renderAll()}),r.value={width:((u=n.value)==null?void 0:u.offsetWidth)||500,height:((j=n.value)==null?void 0:j.offsetHeight)||500},Qe({canvas:i}),window.addEventListener("resize",()=>{Ke({canvas:i,containerRef:n.value})}))}),(i,l)=>(Me(),Ce("div",{class:"container",ref_key:"containerRef",ref:n},[Te("canvas",{id:"canvas",ref_key:"canvasReference",ref:s,width:500,height:500},null,512)],512))}});const Je=Le(Ge,[["__scopeId","data-v-00e31bbc"]]),et=e=>{const t=R(null),o=()=>{t.value&&window.addEventListener("keydown",t.value)},n=()=>{t.value&&window.removeEventListener("keydown",t.value)};return Ie(()=>{t.value=e}),We(()=>{n()}),{addListener:o,removeListener:n}},tt=(e,t)=>{e.key==="Backspace"&&Ee(t)},nt=e=>{if(!e.length)return"";const t=e.reduce((o,[n,r],s,i)=>{const[l,f]=i[(s+1)%i.length];return o.push(n,r,(n+l)/2,(r+f)/2),o},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")};function _e(e,t,o,n=r=>r){return e*n(.5-t*(.5-o))}function ot(e){return[-e[0],-e[1]]}function x(e,t){return[e[0]+t[0],e[1]+t[1]]}function w(e,t){return[e[0]-t[0],e[1]-t[1]]}function k(e,t){return[e[0]*t,e[1]*t]}function rt(e,t){return[e[0]/t,e[1]/t]}function U(e){return[e[1],-e[0]]}function ve(e,t){return e[0]*t[0]+e[1]*t[1]}function st(e,t){return e[0]===t[0]&&e[1]===t[1]}function it(e){return Math.hypot(e[0],e[1])}function lt(e){return e[0]*e[0]+e[1]*e[1]}function Pe(e,t){return lt(w(e,t))}function Ye(e){return rt(e,it(e))}function at(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function $(e,t,o){let n=Math.sin(o),r=Math.cos(o),s=e[0]-t[0],i=e[1]-t[1],l=s*r-i*n,f=s*n+i*r;return[l+t[0],f+t[1]]}function me(e,t,o){return x(e,k(w(t,e),o))}function Oe(e,t,o){return x(e,k(t,o))}var{min:B,PI:ct}=Math,Se=.275,q=ct+1e-4;function ut(e,t={}){let{size:o=16,smoothing:n=.5,thinning:r=.5,simulatePressure:s=!0,easing:i=c=>c,start:l={},end:f={},last:u=!1}=t,{cap:j=!0,easing:a=c=>c*(2-c)}=l,{cap:b=!0,easing:d=c=>--c*c*c+1}=f;if(e.length===0||o<=0)return[];let g=e[e.length-1].runningLength,C=l.taper===!1?0:l.taper===!0?Math.max(o,g):l.taper,P=f.taper===!1?0:f.taper===!0?Math.max(o,g):f.taper,we=Math.pow(o*n,2),T=[],X=[],ie=e.slice(0,10).reduce((c,m)=>{let h=m.pressure;if(s){let p=B(1,m.distance/o),de=B(1,1-p);h=B(1,c+(de-c)*(p*Se))}return(c+h)/2},e[0].pressure),M=_e(o,r,e[e.length-1].pressure,i),le,ae=e[0].vector,W=e[0].point,N=W,I=W,L=N,ce=!1;for(let c=0;c<e.length;c++){let{pressure:m}=e[c],{point:h,vector:p,distance:de,runningLength:E}=e[c];if(c<e.length-1&&g-E<3)continue;if(r){if(s){let A=B(1,de/o),he=B(1,1-A);m=B(1,ie+(he-ie)*(A*Se))}M=_e(o,r,m,i)}else M=o/2;le===void 0&&(le=M);let Xe=E<C?a(E/C):1,Be=g-E<P?d((g-E)/P):1;M=Math.max(.01,M*Math.min(Xe,Be));let ke=(c<e.length-1?e[c+1]:e[c]).vector,fe=c<e.length-1?ve(p,ke):1,Re=ve(p,ae)<0&&!ce,xe=fe!==null&&fe<0;if(Re||xe){let A=k(U(ae),M);for(let he=1/13,Q=0;Q<=1;Q+=he)I=$(w(h,A),h,q*Q),T.push(I),L=$(x(h,A),h,q*-Q),X.push(L);W=I,N=L,xe&&(ce=!0);continue}if(ce=!1,c===e.length-1){let A=k(U(p),M);T.push(w(h,A)),X.push(x(h,A));continue}let je=k(U(me(ke,p,fe)),M);I=w(h,je),(c<=1||Pe(W,I)>we)&&(T.push(I),W=I),L=x(h,je),(c<=1||Pe(N,L)>we)&&(X.push(L),N=L),ie=m,ae=p}let O=e[0].point.slice(0,2),S=e.length>1?e[e.length-1].point.slice(0,2):x(e[0].point,[1,1]),ue=[],K=[];if(e.length===1){if(!(C||P)||u){let c=Oe(O,Ye(U(w(O,S))),-(le||M)),m=[];for(let h=1/13,p=h;p<=1;p+=h)m.push($(c,O,q*2*p));return m}}else{if(!(C||P&&e.length===1))if(j)for(let m=1/13,h=m;h<=1;h+=m){let p=$(X[0],O,q*h);ue.push(p)}else{let m=w(T[0],X[0]),h=k(m,.5),p=k(m,.51);ue.push(w(O,h),w(O,p),x(O,p),x(O,h))}let c=U(ot(e[e.length-1].vector));if(P||C&&e.length===1)K.push(S);else if(b){let m=Oe(S,c,M);for(let h=1/29,p=h;p<1;p+=h)K.push($(m,S,q*3*p))}else K.push(x(S,k(c,M)),x(S,k(c,M*.99)),w(S,k(c,M*.99)),w(S,k(c,M)))}return T.concat(K,X.reverse(),ue)}function dt(e,t={}){var o;let{streamline:n=.5,size:r=16,last:s=!1}=t;if(e.length===0)return[];let i=.15+(1-n)*.85,l=Array.isArray(e[0])?e:e.map(({x:d,y:g,pressure:C=.5})=>[d,g,C]);if(l.length===2){let d=l[1];l=l.slice(0,-1);for(let g=1;g<5;g++)l.push(me(l[0],d,g/4))}l.length===1&&(l=[...l,[...x(l[0],[1,1]),...l[0].slice(2)]]);let f=[{point:[l[0][0],l[0][1]],pressure:l[0][2]>=0?l[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],u=!1,j=0,a=f[0],b=l.length-1;for(let d=1;d<l.length;d++){let g=s&&d===b?l[d].slice(0,2):me(a.point,l[d],i);if(st(a.point,g))continue;let C=at(g,a.point);if(j+=C,d<b&&!u){if(j<r)continue;u=!0}a={point:g,pressure:l[d][2]>=0?l[d][2]:.5,vector:Ye(w(a.point,g)),distance:C,runningLength:j},f.push(a)}return f[0].vector=((o=f[1])==null?void 0:o.vector)||[0,0],f}function ft(e,t={}){return ut(dt(e,t),t)}var ht=ft;const gt=e=>{if(!e){console.error("makeAllObjCanvasUnselectable: canvas is null");return}e.discardActiveObject(),e.selection=!1,e.forEachObject(t=>{t.setOptions({evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1})}),e.renderAll()};let F="",G=!1,ge=[[0,0]];const pt=({canvas:e,drawingSettings:t})=>{if(!e){console.error("drawStrokeOnCanvas: canvas is null");return}e.on("mouse:down",o=>{G=!0,F=V();const n=e.getPointer(o.e);ge=[[n.x,n.y]]}),e.on("mouse:move",o=>{if(!G)return;e.discardActiveObject();const n=e.getPointer(o.e);ge.push([n.x,n.y]);const r=ht(ge,{size:t.size,thinning:t.thinning,smoothing:t.smoothing,streamline:t.streamline,easing(u){return u=Math.max(0,Math.min(1,u)),u*u*(3-2*u)}}),s=nt(r),l=e.getObjects().filter(u=>(u==null?void 0:u.id)===F);if(l.length>0)for(let u=0;u<l.length;u++)e.remove(l[u]);const f=new D.fabric.Path(s,{scaleX:1,scaleY:1,cornerSize:6,evented:!1,selectable:!1,hasRotatingPoint:!1,fill:t.stroke});f.id=F,e.add(f)}),e.on("mouse:up",o=>{if(!G)return;const r=e.getObjects().filter(s=>(s==null?void 0:s.id)===F);for(let s=0;s<r.length;s++){const i=r[s];e.remove(i),i.setCoords(),e.add(i)}F="",G=!1})},bt=(e,t)=>{if(e)return setTimeout(()=>e.requestRenderAll(),t)},mt=({canvas:e,backgroundColor:t})=>{e&&e.setBackgroundColor(t,()=>bt(e,0))};let J=0,ee=0,pe=!1;const yt=({canvas:e})=>{e&&(e.on("mouse:down",t=>{var o,n,r;if(pe=!0,t&&t.e&&t.e.type==="touchstart"){const s=t.e;J=(o=s==null?void 0:s.changedTouches[0])==null?void 0:o.clientX,ee=(n=s==null?void 0:s.changedTouches[0])==null?void 0:n.clientY}(r=t.target)==null||r.setOptions({opacity:.5})}),e.on("mouse:move",t=>{if(!(!pe||!t||!t.e||t.target)){if(t.e.type==="mousemove"){const o=new D.fabric.Point(t.e.movementX,t.e.movementY);e.relativePan(o)}if(t.e.type==="touchmove"){const o=t.e,n=o==null?void 0:o.touches[0];if(!n)return;const r=.9;let s=(n.clientX-J)*r,i=(n.clientY-ee)*r;J=n.clientX,ee=n.clientY;const l=new D.fabric.Point(s,i);e.relativePan(l)}}}),e.on("mouse:up",t=>{var o;pe=!1,(o=t.target)==null||o.setOptions({opacity:1}),J=0,ee=0}))};let te="",ne=!1;const Mt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{ne=!0,te=V();const n=e.getPointer(o.e),r=[n.x,n.y,n.x,n.y],s=new D.fabric.Line(r,{cornerSize:6,strokeWidth:3,cornerStyle:"circle",fill:t.stroke,stroke:t.stroke,originX:"center",originY:"center",evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1});s.id=te,e.add(s)}),e.on("mouse:move",o=>{if(!ne)return;const n=e.getPointer(o.e),s=e.getObjects().filter(i=>(i==null?void 0:i.id)===te);for(let i=0;i<s.length;i++){const l=s[i];l==null||l.setOptions({x2:n.x,y2:n.y})}e.renderAll()}),e.on("mouse:up",()=>{if(!ne)return;ne=!1;const n=e.getObjects().filter(r=>(r==null?void 0:r.id)===te);for(let r=0;r<n.length;r++){const s=n[r];e.remove(s),s.setCoords(),e.add(s)}}))},Ct=Ue();let oe="",H=0,Z=0,be=!1;const wt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{be=!0;const n=e.getPointer(o.e);H=n.x,Z=n.y;const r=new D.fabric.Rect({angle:0,top:Z,left:H,evented:!1,originY:"top",originX:"left",selectable:!1,noScaleCache:!1,hasRotatingPoint:!1,width:n.x-H,height:n.y-Z,rx:t.rx,ry:t.ry,cornerSize:6,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:$e({pasterns:Ct,stroke:t.stroke,background:t.background})});r.on("scaling",s=>qe(s)),r.id=V(),oe=r.id,e.add(r).renderAll()}),e.on("mouse:move",o=>{if(!be||!oe)return;const n=e.getPointer(o.e),s=e.getObjects().find(i=>i.id===oe);s&&(H>n.x&&s.set({left:Math.abs(n.x)}),Z>n.y&&s.set({top:Math.abs(n.y)}),s.setOptions({width:Math.abs(H-n.x),height:Math.abs(Z-n.y)}),e.renderAll())}),e.on("mouse:up",o=>{be=!1;const r=e.getObjects().find(s=>s.id===oe);r&&(e.remove(r),r.setOptions({evented:!0,selectable:!0,hasRotatingPoint:!0}),r.setCoords(),e.add(r),e.setActiveObject(r))}))},Ae=e=>e==="drawing"||e==="panning"||e==="line"||e==="arrow",kt=e=>{if(!e){console.error("makeAllObjCanvasSelectable: canvas is null");return}e.selection=!0,e.forEachObject(t=>{t.setOptions({evented:!0,selectable:!0,hasControls:!0,hasRotatingPoint:!0})}),e.renderAll()},De=e=>{e==null||e.off("mouse:up"),e==null||e.off("mouse:down"),e==null||e.off("mouse:move")};let re="",_=0,v=0,z=0,Y=0,se=!1;const y=5,xt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{se=!0,re=V();const n=e.getPointer(o.e),r=[n.x,n.y,n.x,n.y];z=n.x,Y=n.y;const s=new D.fabric.Line(r,{cornerSize:6,strokeWidth:3,originX:"center",originY:"center",cornerStyle:"circle",fill:t.stroke,stroke:t.stroke,evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1});s.id=re,e.add(s)}),e.on("mouse:move",o=>{if(!se)return;const n=e.getPointer(o.e),s=e.getObjects().filter(i=>(i==null?void 0:i.id)===re);for(let i=0;i<s.length;i++){const l=s[i];l==null||l.setOptions({x2:n.x,y2:n.y})}e.renderAll()}),e.on("mouse:up",o=>{if(!se)return;se=!1;const n=e.getPointer(o.e);if(_=n.x,v=n.y,z===_&&Y===v)return;const r=Math.atan2(v-Y,_-z);_=_-y*Math.cos(r),v=v-y*Math.sin(r);const s=[{x:z,y:Y},{x:z-y/4*Math.cos(r-Math.PI/2),y:Y-y/4*Math.sin(r-Math.PI/2)},{x:_-y/4*Math.cos(r-Math.PI/2),y:v-y/4*Math.sin(r-Math.PI/2)},{x:_-y*Math.cos(r-Math.PI/2),y:v-y*Math.sin(r-Math.PI/2)},{x:_+y*2*Math.cos(r),y:v+y*2*Math.sin(r)},{x:_-y*Math.cos(r+Math.PI/2),y:v-y*Math.sin(r+Math.PI/2)},{x:_-y/4*Math.cos(r+Math.PI/2),y:v-y/4*Math.sin(r+Math.PI/2)},{x:z-y/4*Math.cos(r+Math.PI/2),y:Y-y/4*Math.sin(r+Math.PI/2)},{x:z,y:Y}],i=new D.fabric.Polyline(s,{opacity:1,cornerSize:6,evented:!0,selectable:!0,hasControls:!0,objectCaching:!1,hasRotatingPoint:!0,fill:t.stroke}),l=V();i.id=l,e.add(i),e.forEachObject(f=>{const u=f;u.id===re&&e.remove(u),u.id===l&&(e.remove(u),u.setCoords(),e.add(u),e.setActiveObject(u))}),e.renderAll()}))},jt=ye({__name:"MainCanvas",setup(e){const t=Fe(),o=He(),n=R(null),{addListener:r,removeListener:s}=et(a=>{const b=o.getSelectedCanvas;b&&tt(a,b)}),i=a=>{var d,g;if(console.log("double click",a),a.target&&a.target.type==="i-text"){a.target.enterEditing(),s();return}const b={y:((d=a.pointer)==null?void 0:d.y)||0,x:(((g=a.pointer)==null?void 0:g.x)||0)-100};Ve({position:b,text:"Double click to edit text",canvas:o.getSelectedCanvas})},l=a=>{console.log("mouse down",a)},f=a=>{o.setSelectedCanvas({selectedCanvas:a})},u=a=>{console.log("selection",a),r(),t.setCanvasMode({canvasMode:"ObjContextMenu"})},j=a=>{t.setCanvasMode({canvasMode:"mainMenu"})};return Ze(()=>({getCanvasMode:t.getCanvasMode,getIsDotBackground:t.getIsDotBackground,getSelectedCanvas:o.getSelectedCanvas,getDrawingSettings:o.getDrawingSettings,getSquareModeSettings:o.getSquareModeSettings}),a=>{const{getCanvasMode:b,getSelectedCanvas:d,getDrawingSettings:g,getIsDotBackground:C,getSquareModeSettings:P}=a;switch(De(d),Ae(b)&&(console.log("unselectable"),gt(d)),Ae(b)||(console.log("selectable"),kt(d)),t.getCanvasMode){case"drawing":pt({canvas:d,drawingSettings:g});break;case"panning":yt({canvas:d});break;case"square":wt({canvas:d,squareModeSettings:P});break;case"line":Mt({canvas:d,squareModeSettings:P});break;case"arrow":xt({canvas:d,squareModeSettings:P});break;default:De(d);break}mt({canvas:d,backgroundColor:C?Ne({}):"transparent"})}),(a,b)=>(Me(),Ce("div",{class:"design-canvas-container",ref_key:"elRef",ref:n},[ze(Je,{id:"1",onMouseDown:l,onMouseDblclick:i,onCanvasCreated:f,onSelectionCreated:u,onSelectionUpdated:u,onSelectionCleared:j})],512))}});const _t=Le(jt,[["__scopeId","data-v-13beea1f"]]),Pt=ye({__name:"DesignView",setup(e){return(t,o)=>(Me(),Ce("main",null,[ze(_t)]))}});export{Pt as default};
