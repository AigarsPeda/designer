import{d as ae,r as Y,b as ke,f as T,o as ce,c as ue,a as Ae,_ as ye,e as Ye,h as Xe,g as je,i as Be,j as Le,u as ze,k as Ie,w as We,l as Me,m as Re,n as Ee}from"./index-61d662f3.js";const He=({canvas:e,containerRef:t})=>{const n=(t==null?void 0:t.offsetWidth)||500,o=(t==null?void 0:t.offsetHeight)||500;e==null||e.setDimensions({width:n,height:o})},Te=({canvas:e})=>{e.on("mouse:wheel",t=>{const n=t.e.deltaY;let o=e.getZoom();o*=.999**n,o>20&&(o=20),o<.01&&(o=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},o),t.e.preventDefault(),t.e.stopPropagation()})},Ue=ae({__name:"FabricCanvas",props:{id:{}},emits:["canvas-created","mouse-down","mouse-dblclick","selection-created","selection-cleared","selection-updated"],setup(e,{emit:t}){const n=Y(null),o=Y(null),i=Y({width:0,height:0}),s=Y(null);return ke(()=>{var r,d,f,y;const a=new T.fabric.Canvas(s.value,{preserveObjectStacking:!0,width:((r=o.value)==null?void 0:r.offsetWidth)||500,height:((d=o.value)==null?void 0:d.offsetHeight)||500});a&&(n.value=a,t("canvas-created",a),a.on("selection:created",l=>{t("selection-created",l)}),a.on("selection:updated",l=>{t("selection-updated",l)}),a.on("selection:cleared",l=>{t("selection-cleared",l)}),a.on("mouse:dblclick",l=>{t("mouse-dblclick",l)}),a.on("mouse:down:before",l=>{t("mouse-down",l)}),a.on("object:modified",l=>{var b;(b=l.target)==null||b.set({opacity:1}),a.renderAll()}),a.on("object:moving",l=>{var b;(b=l.target)==null||b.set({opacity:.75}),a.renderAll()}),i.value={width:((f=o.value)==null?void 0:f.offsetWidth)||500,height:((y=o.value)==null?void 0:y.offsetHeight)||500},Te({canvas:a}),window.addEventListener("resize",()=>{He({canvas:a,containerRef:o.value})}))}),(a,r)=>(ce(),ue("div",{class:"container",ref_key:"containerRef",ref:o},[Ae("canvas",{id:"canvas",ref_key:"canvasReference",ref:s,width:500,height:500},null,512)],512))}});const qe=ye(Ue,[["__scopeId","data-v-00e31bbc"]]),Fe=e=>{const t=Y(null),n=()=>{t.value&&window.addEventListener("keydown",t.value)},o=()=>{t.value&&window.removeEventListener("keydown",t.value)};return ke(()=>{t.value=e}),Ye(()=>{o()}),{addListener:n,removeListener:o}},Ze=(e,t)=>{e.key==="Backspace"&&Xe(t)},Oe=e=>{if(!e){console.error("makeAllObjCanvasUnselectable: canvas is null");return}e.selection=!1,e.discardActiveObject(),e.forEachObject(t=>{t.setOptions({evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1})})},Ve=e=>{if(!e.length)return"";const t=e.reduce((n,[o,i],s,a)=>{const[r,d]=a[(s+1)%a.length];return n.push(o,i,(o+r)/2,(i+d)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")};function pe(e,t,n,o=i=>i){return e*o(.5-t*(.5-n))}function Ne(e){return[-e[0],-e[1]]}function k(e,t){return[e[0]+t[0],e[1]+t[1]]}function _(e,t){return[e[0]-t[0],e[1]-t[1]]}function w(e,t){return[e[0]*t,e[1]*t]}function $e(e,t){return[e[0]/t,e[1]/t]}function z(e){return[e[1],-e[0]]}function be(e,t){return e[0]*t[0]+e[1]*t[1]}function Ke(e,t){return e[0]===t[0]&&e[1]===t[1]}function Qe(e){return Math.hypot(e[0],e[1])}function Ge(e){return e[0]*e[0]+e[1]*e[1]}function me(e,t){return Ge(_(e,t))}function Se(e){return $e(e,Qe(e))}function Je(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function I(e,t,n){let o=Math.sin(n),i=Math.cos(n),s=e[0]-t[0],a=e[1]-t[1],r=s*i-a*o,d=s*o+a*i;return[r+t[0],d+t[1]]}function le(e,t,n){return k(e,w(_(t,e),n))}function ve(e,t,n){return k(e,w(t,n))}var{min:A,PI:et}=Math,Ce=.275,W=et+1e-4;function tt(e,t={}){let{size:n=16,smoothing:o=.5,thinning:i=.5,simulatePressure:s=!0,easing:a=c=>c,start:r={},end:d={},last:f=!1}=t,{cap:y=!0,easing:l=c=>c*(2-c)}=r,{cap:b=!0,easing:u=c=>--c*c*c+1}=d;if(e.length===0||n<=0)return[];let g=e[e.length-1].runningLength,C=r.taper===!1?0:r.taper===!0?Math.max(n,g):r.taper,S=d.taper===!1?0:d.taper===!0?Math.max(n,g):d.taper,de=Math.pow(n*o,2),X=[],D=[],K=e.slice(0,10).reduce((c,m)=>{let h=m.pressure;if(s){let p=A(1,m.distance/n),te=A(1,1-p);h=A(1,c+(te-c)*(p*Ce))}return(c+h)/2},e[0].pressure),v=pe(n,i,e[e.length-1].pressure,a),Q,G=e[0].vector,B=e[0].point,U=B,x=B,P=U,J=!1;for(let c=0;c<e.length;c++){let{pressure:m}=e[c],{point:h,vector:p,distance:te,runningLength:L}=e[c];if(c<e.length-1&&g-L<3)continue;if(i){if(s){let O=A(1,te/n),oe=A(1,1-O);m=A(1,K+(oe-K)*(O*Ce))}v=pe(n,i,m,a)}else v=n/2;Q===void 0&&(Q=v);let xe=L<C?l(L/C):1,Pe=g-L<S?u((g-L)/S):1;v=Math.max(.01,v*Math.min(xe,Pe));let fe=(c<e.length-1?e[c+1]:e[c]).vector,ne=c<e.length-1?be(p,fe):1,De=be(p,G)<0&&!J,he=ne!==null&&ne<0;if(De||he){let O=w(z(G),v);for(let oe=1/13,F=0;F<=1;F+=oe)x=I(_(h,O),h,W*F),X.push(x),P=I(k(h,O),h,W*-F),D.push(P);B=x,U=P,he&&(J=!0);continue}if(J=!1,c===e.length-1){let O=w(z(p),v);X.push(_(h,O)),D.push(k(h,O));continue}let ge=w(z(le(fe,p,ne)),v);x=_(h,ge),(c<=1||me(B,x)>de)&&(X.push(x),B=x),P=k(h,ge),(c<=1||me(U,P)>de)&&(D.push(P),U=P),K=m,G=p}let j=e[0].point.slice(0,2),M=e.length>1?e[e.length-1].point.slice(0,2):k(e[0].point,[1,1]),ee=[],q=[];if(e.length===1){if(!(C||S)||f){let c=ve(j,Se(z(_(j,M))),-(Q||v)),m=[];for(let h=1/13,p=h;p<=1;p+=h)m.push(I(c,j,W*2*p));return m}}else{if(!(C||S&&e.length===1))if(y)for(let m=1/13,h=m;h<=1;h+=m){let p=I(D[0],j,W*h);ee.push(p)}else{let m=_(X[0],D[0]),h=w(m,.5),p=w(m,.51);ee.push(_(j,h),_(j,p),k(j,p),k(j,h))}let c=z(Ne(e[e.length-1].vector));if(S||C&&e.length===1)q.push(M);else if(b){let m=ve(M,c,v);for(let h=1/29,p=h;p<1;p+=h)q.push(I(m,M,W*3*p))}else q.push(k(M,w(c,v)),k(M,w(c,v*.99)),_(M,w(c,v*.99)),_(M,w(c,v)))}return X.concat(q,D.reverse(),ee)}function nt(e,t={}){var n;let{streamline:o=.5,size:i=16,last:s=!1}=t;if(e.length===0)return[];let a=.15+(1-o)*.85,r=Array.isArray(e[0])?e:e.map(({x:u,y:g,pressure:C=.5})=>[u,g,C]);if(r.length===2){let u=r[1];r=r.slice(0,-1);for(let g=1;g<5;g++)r.push(le(r[0],u,g/4))}r.length===1&&(r=[...r,[...k(r[0],[1,1]),...r[0].slice(2)]]);let d=[{point:[r[0][0],r[0][1]],pressure:r[0][2]>=0?r[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],f=!1,y=0,l=d[0],b=r.length-1;for(let u=1;u<r.length;u++){let g=s&&u===b?r[u].slice(0,2):le(l.point,r[u],a);if(Ke(l.point,g))continue;let C=Je(g,l.point);if(y+=C,u<b&&!f){if(y<i)continue;f=!0}l={point:g,pressure:r[u][2]>=0?r[u][2]:.5,vector:Se(_(l.point,g)),distance:C,runningLength:y},d.push(l)}return d[0].vector=((n=d[1])==null?void 0:n.vector)||[0,0],d}function ot(e,t={}){return tt(nt(e,t),t)}var st=ot;let R="",Z=!1,se=[[0,0]];const rt=({canvas:e,drawingSettings:t})=>{if(!e){console.error("drawStrokeOnCanvas: canvas is null");return}e.on("mouse:down",n=>{Z=!0,R=je();const o=e.getPointer(n.e);se=[[o.x,o.y]]}),e.on("mouse:move",n=>{if(!Z)return;e.discardActiveObject();const o=e.getPointer(n.e);se.push([o.x,o.y]);const i=st(se,{size:t.size,thinning:t.thinning,smoothing:t.smoothing,streamline:t.streamline,easing(f){return f=Math.max(0,Math.min(1,f)),f*f*(3-2*f)}}),s=Ve(i),r=e.getObjects().filter(f=>(f==null?void 0:f.id)===R);if(r.length>0)for(let f=0;f<r.length;f++)e.remove(r[f]);const d=new T.fabric.Path(s,{scaleX:1,scaleY:1,cornerSize:6,evented:!1,selectable:!1,hasRotatingPoint:!1,fill:t.stroke});d.id=R,e.add(d)}),e.on("mouse:up",n=>{if(!Z)return;const i=e.getObjects().filter(s=>(s==null?void 0:s.id)===R);for(let s=0;s<i.length;s++){const a=i[s];e.remove(a),a.set({evented:!0,selectable:!0,hasRotatingPoint:!0}),a.setCoords(),e.add(a),e.renderAll()}R="",Z=!1,Oe(e)})},it=(e,t)=>{if(e)return setTimeout(()=>e.requestRenderAll(),t)},lt=({canvas:e,backgroundColor:t})=>{e&&e.setBackgroundColor(t,()=>it(e,0))};let V=0,N=0,re=!1;const at=({canvas:e})=>{e&&(e.on("mouse:down",t=>{var n,o,i;if(re=!0,t&&t.e&&t.e.type==="touchstart"){const s=t.e;V=(n=s==null?void 0:s.changedTouches[0])==null?void 0:n.clientX,N=(o=s==null?void 0:s.changedTouches[0])==null?void 0:o.clientY}(i=t.target)==null||i.setOptions({opacity:.5})}),e.on("mouse:move",t=>{if(!(!re||!t||!t.e||t.target)){if(t.e.type==="mousemove"){const n=new T.fabric.Point(t.e.movementX,t.e.movementY);e.relativePan(n)}if(t.e.type==="touchmove"){const n=t.e,o=n==null?void 0:n.touches[0];if(!o)return;const i=.9;let s=(o.clientX-V)*i,a=(o.clientY-N)*i;V=o.clientX,N=o.clientY;const r=new T.fabric.Point(s,a);e.relativePan(r)}}}),e.on("mouse:up",t=>{var n;re=!1,(n=t.target)==null||n.setOptions({opacity:1}),V=0,N=0}))},ct=e=>{var n;const t=(n=e.transform)==null?void 0:n.target;if(t){const o=t.scaleX||1,i=t.scaleY||1,s=t.width||1,a=t.height||1,r=s*o,d=a*i;t.set({width:r,height:d,scaleX:1,scaleY:1}),t.setCoords()}},ut=Be();let $="",E=0,H=0,ie=!1;const dt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",n=>{ie=!0;const o=e.getPointer(n.e);E=o.x,H=o.y;const i=new T.fabric.Rect({angle:0,top:H,left:E,evented:!1,originY:"top",originX:"left",selectable:!1,noScaleCache:!1,hasRotatingPoint:!1,width:o.x-E,height:o.y-H,rx:t.rx,ry:t.ry,cornerSize:6,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:Le({pasterns:ut,stroke:t.stroke,background:t.background})});i.on("scaling",s=>ct(s)),i.id=je(),$=i.id,e.add(i).renderAll()}),e.on("mouse:move",n=>{if(!ie||!$)return;const o=e.getPointer(n.e),s=e.getObjects().find(a=>a.id===$);s&&(E>o.x&&s.set({left:Math.abs(o.x)}),H>o.y&&s.set({top:Math.abs(o.y)}),s.setOptions({width:Math.abs(E-o.x),height:Math.abs(H-o.y)}),e.renderAll())}),e.on("mouse:up",n=>{ie=!1;const i=e.getObjects().find(s=>s.id===$);i&&(e.remove(i),i.setOptions({evented:!0,selectable:!0,hasRotatingPoint:!0}),i.setCoords(),e.add(i),e.setActiveObject(i))}))},_e=e=>e==="drawing"||e==="panning",ft=e=>{if(!e){console.error("makeAllObjCanvasSelectable: canvas is null");return}e.selection=!0,e.forEachObject(t=>{t.setOptions({evented:!0,selectable:!0,hasControls:!0,hasRotatingPoint:!0})})},we=e=>{e==null||e.off("mouse:up"),e==null||e.off("mouse:down"),e==null||e.off("mouse:move")},ht=ae({__name:"MainCanvas",setup(e){const t=ze(),n=Ie(),o=Y(null),{addListener:i,removeListener:s}=Fe(l=>{const b=n.getSelectedCanvas;b&&Ze(l,b)}),a=l=>{var u,g;if(console.log("double click",l),l.target&&l.target.type==="i-text"){l.target.enterEditing(),s();return}const b={y:((u=l.pointer)==null?void 0:u.y)||0,x:(((g=l.pointer)==null?void 0:g.x)||0)-100};Re({position:b,text:"Double click to edit text",canvas:n.getSelectedCanvas})},r=l=>{console.log("mouse down",l)},d=l=>{n.setSelectedCanvas({selectedCanvas:l})},f=l=>{console.log("selection",l),i(),t.setCanvasMode({canvasMode:"ObjContextMenu"})},y=l=>{t.setCanvasMode({canvasMode:"mainMenu"})};return We(()=>({getCanvasMode:t.getCanvasMode,getIsDotBackground:t.getIsDotBackground,getSelectedCanvas:n.getSelectedCanvas,getDrawingSettings:n.getDrawingSettings,getSquareModeSettings:n.getSquareModeSettings}),l=>{const{getCanvasMode:b,getSelectedCanvas:u,getDrawingSettings:g,getIsDotBackground:C,getSquareModeSettings:S}=l;switch(we(u),_e(b)&&Oe(u),_e(b)||ft(u),t.getCanvasMode){case"drawing":rt({canvas:u,drawingSettings:g});break;case"panning":at({canvas:u});break;case"square":dt({canvas:u,squareModeSettings:S});break;default:we(u);break}lt({canvas:u,backgroundColor:C?Ee({}):"transparent"})}),(l,b)=>(ce(),ue("div",{class:"design-canvas-container",ref_key:"elRef",ref:o},[Me(qe,{id:"1",onMouseDown:r,onMouseDblclick:a,onCanvasCreated:d,onSelectionCreated:f,onSelectionUpdated:f,onSelectionCleared:y})],512))}});const gt=ye(ht,[["__scopeId","data-v-3ef4a1e4"]]),bt=ae({__name:"DesignView",setup(e){return(t,n)=>(ce(),ue("main",null,[Me(gt)]))}});export{bt as default};
