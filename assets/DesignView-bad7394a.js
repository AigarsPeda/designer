import{d as ae,r as L,b as ye,f as R,o as ce,c as ue,a as Be,_ as Oe,e as Le,g as Me,h as Re,i as Ie,u as Ye,j as ze,w as We,k as xe,l as Xe,m as Ee}from"./index-1394f9da.js";const Fe=({canvas:e,containerRef:t})=>{const n=(t==null?void 0:t.offsetWidth)||500,o=(t==null?void 0:t.offsetHeight)||500;e==null||e.setDimensions({width:n,height:o})},Te=({canvas:e})=>{e.on("mouse:wheel",t=>{const n=t.e.deltaY;let o=e.getZoom();o*=.999**n,o>20&&(o=20),o<.01&&(o=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},o),t.e.preventDefault(),t.e.stopPropagation()})},Ue=ae({__name:"FabricCanvas",props:{id:{}},emits:["canvas-created","mouse-down","mouse-dblclick","selection-created","selection-cleared","selection-updated"],setup(e,{emit:t}){const n=L(null),o=L(null),s=L({width:0,height:0}),i=L(null);return ye(()=>{var r,g,k,y;const a=new R.fabric.Canvas(i.value,{width:((r=o.value)==null?void 0:r.offsetWidth)||500,height:((g=o.value)==null?void 0:g.offsetHeight)||500});a&&(n.value=a,t("canvas-created",a),a.on("selection:created",l=>{t("selection-created",l)}),a.on("selection:updated",l=>{t("selection-updated",l)}),a.on("selection:cleared",l=>{t("selection-cleared",l)}),a.on("mouse:dblclick",l=>{t("mouse-dblclick",l)}),a.on("mouse:down:before",l=>{t("mouse-down",l)}),s.value={width:((k=o.value)==null?void 0:k.offsetWidth)||500,height:((y=o.value)==null?void 0:y.offsetHeight)||500},Te({canvas:a}),window.addEventListener("resize",()=>{Fe({canvas:a,containerRef:o.value})}))}),(a,r)=>(ce(),ue("div",{class:"container",ref_key:"containerRef",ref:o},[Be("canvas",{id:"canvas",ref_key:"canvasReference",ref:i,width:500,height:500},null,512)],512))}});const qe=Oe(Ue,[["__scopeId","data-v-e5eaa40a"]]),He=e=>{const t=L(null),n=()=>{t.value&&window.addEventListener("keydown",t.value)},o=()=>{t.value&&window.removeEventListener("keydown",t.value)};return ye(()=>{t.value=e}),Le(()=>{o()}),{addListener:n,removeListener:o}},Ve=(e,t)=>{if(e.key==="Backspace"){const n=t.getActiveObject();if(!n)return;t.remove(n)}},Se=e=>{if(!e){console.error("makeAllObjCanvasUnselectable: canvas is null");return}e.selection=!1,e.discardActiveObject(),e.forEachObject(t=>{t.setOptions({evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1})})},pe=e=>{e==null||e.off("mouse:up"),e==null||e.off("mouse:down"),e==null||e.off("mouse:move")},Ze=e=>{if(!e.length)return"";const t=e.reduce((n,[o,s],i,a)=>{const[r,g]=a[(i+1)%a.length];return n.push(o,s,(o+r)/2,(s+g)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")};function me(e,t,n,o=s=>s){return e*o(.5-t*(.5-n))}function $e(e){return[-e[0],-e[1]]}function w(e,t){return[e[0]+t[0],e[1]+t[1]]}function _(e,t){return[e[0]-t[0],e[1]-t[1]]}function C(e,t){return[e[0]*t,e[1]*t]}function Ge(e,t){return[e[0]/t,e[1]/t]}function W(e){return[e[1],-e[0]]}function be(e,t){return e[0]*t[0]+e[1]*t[1]}function Ke(e,t){return e[0]===t[0]&&e[1]===t[1]}function Ne(e){return Math.hypot(e[0],e[1])}function Qe(e){return e[0]*e[0]+e[1]*e[1]}function ve(e,t){return Qe(_(e,t))}function je(e){return Ge(e,Ne(e))}function Je(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function X(e,t,n){let o=Math.sin(n),s=Math.cos(n),i=e[0]-t[0],a=e[1]-t[1],r=i*s-a*o,g=i*o+a*s;return[r+t[0],g+t[1]]}function le(e,t,n){return w(e,C(_(t,e),n))}function _e(e,t,n){return w(e,C(t,n))}var{min:A,PI:et}=Math,Ce=.275,E=et+1e-4;function tt(e,t={}){let{size:n=16,smoothing:o=.5,thinning:s=.5,simulatePressure:i=!0,easing:a=c=>c,start:r={},end:g={},last:k=!1}=t,{cap:y=!0,easing:l=c=>c*(2-c)}=r,{cap:b=!0,easing:u=c=>--c*c*c+1}=g;if(e.length===0||n<=0)return[];let f=e[e.length-1].runningLength,v=r.taper===!1?0:r.taper===!0?Math.max(n,f):r.taper,S=g.taper===!1?0:g.taper===!0?Math.max(n,f):g.taper,de=Math.pow(n*o,2),I=[],D=[],K=e.slice(0,10).reduce((c,p)=>{let d=p.pressure;if(i){let h=A(1,p.distance/n),te=A(1,1-h);d=A(1,c+(te-c)*(h*Ce))}return(c+d)/2},e[0].pressure),m=me(n,s,e[e.length-1].pressure,a),N,Q=e[0].vector,Y=e[0].point,U=Y,j=Y,P=U,J=!1;for(let c=0;c<e.length;c++){let{pressure:p}=e[c],{point:d,vector:h,distance:te,runningLength:z}=e[c];if(c<e.length-1&&f-z<3)continue;if(s){if(i){let x=A(1,te/n),oe=A(1,1-x);p=A(1,K+(oe-K)*(x*Ce))}m=me(n,s,p,a)}else m=n/2;N===void 0&&(N=m);let Pe=z<v?l(z/v):1,De=f-z<S?u((f-z)/S):1;m=Math.max(.01,m*Math.min(Pe,De));let fe=(c<e.length-1?e[c+1]:e[c]).vector,ne=c<e.length-1?be(h,fe):1,Ae=be(h,Q)<0&&!J,he=ne!==null&&ne<0;if(Ae||he){let x=C(W(Q),m);for(let oe=1/13,H=0;H<=1;H+=oe)j=X(_(d,x),d,E*H),I.push(j),P=X(w(d,x),d,E*-H),D.push(P);Y=j,U=P,he&&(J=!0);continue}if(J=!1,c===e.length-1){let x=C(W(h),m);I.push(_(d,x)),D.push(w(d,x));continue}let ge=C(W(le(fe,h,ne)),m);j=_(d,ge),(c<=1||ve(Y,j)>de)&&(I.push(j),Y=j),P=w(d,ge),(c<=1||ve(U,P)>de)&&(D.push(P),U=P),K=p,Q=h}let O=e[0].point.slice(0,2),M=e.length>1?e[e.length-1].point.slice(0,2):w(e[0].point,[1,1]),ee=[],q=[];if(e.length===1){if(!(v||S)||k){let c=_e(O,je(W(_(O,M))),-(N||m)),p=[];for(let d=1/13,h=d;h<=1;h+=d)p.push(X(c,O,E*2*h));return p}}else{if(!(v||S&&e.length===1))if(y)for(let p=1/13,d=p;d<=1;d+=p){let h=X(D[0],O,E*d);ee.push(h)}else{let p=_(I[0],D[0]),d=C(p,.5),h=C(p,.51);ee.push(_(O,d),_(O,h),w(O,h),w(O,d))}let c=W($e(e[e.length-1].vector));if(S||v&&e.length===1)q.push(M);else if(b){let p=_e(M,c,m);for(let d=1/29,h=d;h<1;h+=d)q.push(X(p,M,E*3*h))}else q.push(w(M,C(c,m)),w(M,C(c,m*.99)),_(M,C(c,m*.99)),_(M,C(c,m)))}return I.concat(q,D.reverse(),ee)}function nt(e,t={}){var n;let{streamline:o=.5,size:s=16,last:i=!1}=t;if(e.length===0)return[];let a=.15+(1-o)*.85,r=Array.isArray(e[0])?e:e.map(({x:u,y:f,pressure:v=.5})=>[u,f,v]);if(r.length===2){let u=r[1];r=r.slice(0,-1);for(let f=1;f<5;f++)r.push(le(r[0],u,f/4))}r.length===1&&(r=[...r,[...w(r[0],[1,1]),...r[0].slice(2)]]);let g=[{point:[r[0][0],r[0][1]],pressure:r[0][2]>=0?r[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],k=!1,y=0,l=g[0],b=r.length-1;for(let u=1;u<r.length;u++){let f=i&&u===b?r[u].slice(0,2):le(l.point,r[u],a);if(Ke(l.point,f))continue;let v=Je(f,l.point);if(y+=v,u<b&&!k){if(y<s)continue;k=!0}l={point:f,pressure:r[u][2]>=0?r[u][2]:.5,vector:je(_(l.point,f)),distance:v,runningLength:y},g.push(l)}return g[0].vector=((n=g[1])==null?void 0:n.vector)||[0,0],g}function ot(e,t={}){return tt(nt(e,t),t)}var st=ot;const we="drawnObjects";let V=!1,se=[[0,0]],B=null;const rt=({canvas:e,drawingSettings:t})=>{if(!e){console.error("drawStrokeOnCanvas: canvas is null");return}e.on("mouse:down",n=>{V=!0,B=null;const o=e.getPointer(n.e);se=[[o.x,o.y]]}),e.on("mouse:move",n=>{if(!V)return;e.discardActiveObject();const o=e.getPointer(n.e);se.push([o.x,o.y]);const s=st(se,{size:t.size,thinning:t.thinning,smoothing:t.smoothing,streamline:t.streamline,easing(a){return a=Math.max(0,Math.min(1,a)),a*a*(3-2*a)}}),i=Ze(s);R.fabric.loadSVGFromString(`<svg>
         <path fill="${t.stroke}" d="${i}" />
      </svg>`,a=>{const r=new R.fabric.Group(a,{id:we,selectable:!1,hasRotatingPoint:!1});B=r,e.add(r)})}),e.on("mouse:up",n=>{if(!V)return;const s=e.getObjects().filter(i=>(i==null?void 0:i.id)===we);if(s.length>0&&B){for(let i=0;i<s.length;i++)e.remove(s[i]);B.setOptions({selectable:!0,id:Me(),hasRotatingPoint:!0}),B.bringForward(!0),e.add(B),e.renderAll()}Se(e),V=!1})},it=(e,t)=>{if(e)return setTimeout(()=>e.requestRenderAll(),t)},lt=({canvas:e,backgroundColor:t})=>{e&&e.setBackgroundColor(t,()=>it(e,0))};let Z=0,$=0,re=!1;const at=({canvas:e})=>{e&&(e.on("mouse:down",t=>{var n,o,s;if(re=!0,t&&t.e&&t.e.type==="touchstart"){const i=t.e;Z=(n=i==null?void 0:i.changedTouches[0])==null?void 0:n.clientX,$=(o=i==null?void 0:i.changedTouches[0])==null?void 0:o.clientY}(s=t.target)==null||s.setOptions({opacity:.5})}),e.on("mouse:move",t=>{if(!(!re||!t||!t.e||t.target)){if(t.e.type==="mousemove"){const n=new R.fabric.Point(t.e.movementX,t.e.movementY);e.relativePan(n)}if(t.e.type==="touchmove"){const n=t.e,o=n==null?void 0:n.touches[0];if(!o)return;const s=.9;let i=(o.clientX-Z)*s,a=(o.clientY-$)*s;Z=o.clientX,$=o.clientY;const r=new R.fabric.Point(i,a);e.relativePan(r)}}}),e.on("mouse:up",t=>{var n;re=!1,(n=t.target)==null||n.setOptions({opacity:1}),Z=0,$=0}))},ct=Re();let G="",F=0,T=0,ie=!1;const ut=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",n=>{ie=!0;const o=e.getPointer(n.e);F=o.x,T=o.y;const s=new R.fabric.Rect({angle:0,top:T,left:F,evented:!1,originY:"top",originX:"left",selectable:!1,hasRotatingPoint:!1,width:o.x-F,height:o.y-T,rx:t.rx,ry:t.ry,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:Ie({pasterns:ct,stroke:t.stroke,background:t.background})});s.id=Me(),G=s.id,e.add(s),e.renderAll()}),e.on("mouse:move",n=>{if(!ie||!G)return;const o=e.getPointer(n.e),i=e.getObjects().find(a=>a.id===G);i&&(F>o.x&&i.set({left:Math.abs(o.x)}),T>o.y&&i.set({top:Math.abs(o.y)}),i.setOptions({width:Math.abs(F-o.x),height:Math.abs(T-o.y)}),e.renderAll())}),e.on("mouse:up",n=>{ie=!1;const s=e.getObjects().find(i=>i.id===G);s&&(e.remove(s),s.setOptions({evented:!0,selectable:!0,hasRotatingPoint:!0}),s.setCoords(),e.add(s),e.setActiveObject(s))}))},ke=e=>e==="drawing"||e==="panning",dt=e=>{if(!e){console.error("makeAllObjCanvasSelectable: canvas is null");return}e.selection=!0,e.forEachObject(t=>{t.setOptions({evented:!0,selectable:!0,hasControls:!0,hasRotatingPoint:!0})})},ft=ae({__name:"MainCanvas",setup(e){const t=Ye(),n=ze(),o=L(null),{addListener:s,removeListener:i}=He(l=>{const b=n.getSelectedCanvas;b&&Ve(l,b)}),a=l=>{var u,f;if(console.log("double click",l),l.target&&l.target.type==="i-text"){l.target.enterEditing(),i();return}const b={y:((u=l.pointer)==null?void 0:u.y)||0,x:(((f=l.pointer)==null?void 0:f.x)||0)-100};Xe({position:b,text:"Double click to edit text",canvas:n.getSelectedCanvas})},r=l=>{console.log("mouse down",l)},g=l=>{n.setSelectedCanvas({selectedCanvas:l})},k=l=>{console.log("selection",l),s(),t.setCanvasMode({canvasMode:"ObjContextMenu"})},y=l=>{console.log("selection cleared",l),t.setCanvasMode({canvasMode:"mainMenu"})};return We(()=>({getCanvasMode:t.getCanvasMode,getIsDotBackground:t.getIsDotBackground,getSelectedCanvas:n.getSelectedCanvas,getDrawingSettings:n.getDrawingSettings,getSquareModeSettings:n.getSquareModeSettings}),l=>{const{getCanvasMode:b,getSelectedCanvas:u,getDrawingSettings:f,getIsDotBackground:v,getSquareModeSettings:S}=l;switch(pe(u),ke(b)&&Se(u),ke(b)||dt(u),t.getCanvasMode){case"drawing":rt({canvas:u,drawingSettings:f});break;case"panning":at({canvas:u});break;case"square":ut({canvas:u,squareModeSettings:S});break;default:pe(u);break}lt({canvas:u,backgroundColor:v?Ee({}):"transparent"})}),(l,b)=>(ce(),ue("div",{class:"design-canvas-container",ref_key:"elRef",ref:o},[xe(qe,{id:"1",onMouseDown:r,onMouseDblclick:a,onCanvasCreated:g,onSelectionCreated:k,onSelectionUpdated:k,onSelectionCleared:y})],512))}});const ht=Oe(ft,[["__scopeId","data-v-c35945dd"]]),pt=ae({__name:"DesignView",setup(e){return(t,n)=>(ce(),ue("main",null,[xe(ht)]))}});export{pt as default};
