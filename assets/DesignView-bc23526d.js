import{d as ue,r as Y,b as Se,f as L,o as de,c as fe,a as Ye,_ as xe,e as Le,h as Xe,g as he,i as ze,j as Be,u as We,k as Ie,w as Re,l as Oe,m as Te,n as Ee}from"./index-2010602e.js";const He=({canvas:e,containerRef:t})=>{const o=(t==null?void 0:t.offsetWidth)||500,n=(t==null?void 0:t.offsetHeight)||500;e==null||e.setDimensions({width:o,height:n})},Ue=({canvas:e})=>{e.on("mouse:wheel",t=>{const o=t.e.deltaY;let n=e.getZoom();n*=.999**o,n>20&&(n=20),n<.01&&(n=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},n),t.e.preventDefault(),t.e.stopPropagation()})},qe=ue({__name:"FabricCanvas",props:{id:{}},emits:["canvas-created","mouse-down","mouse-dblclick","selection-created","selection-cleared","selection-updated"],setup(e,{emit:t}){const o=Y(null),n=Y(null),r=Y({width:0,height:0}),s=Y(null);return Se(()=>{var l,d,f,j;const i=new L.fabric.Canvas(s.value,{preserveObjectStacking:!0,width:((l=n.value)==null?void 0:l.offsetWidth)||500,height:((d=n.value)==null?void 0:d.offsetHeight)||500});i&&(o.value=i,t("canvas-created",i),i.on("selection:created",a=>{t("selection-created",a)}),i.on("selection:updated",a=>{t("selection-updated",a)}),i.on("selection:cleared",a=>{t("selection-cleared",a)}),i.on("mouse:dblclick",a=>{t("mouse-dblclick",a)}),i.on("mouse:down:before",a=>{t("mouse-down",a)}),i.on("object:modified",a=>{var b;(b=a.target)==null||b.set({opacity:1}),i.renderAll()}),i.on("object:moving",a=>{var b;(b=a.target)==null||b.set({opacity:.75}),i.renderAll()}),r.value={width:((f=n.value)==null?void 0:f.offsetWidth)||500,height:((j=n.value)==null?void 0:j.offsetHeight)||500},Ue({canvas:i}),window.addEventListener("resize",()=>{He({canvas:i,containerRef:n.value})}))}),(i,l)=>(de(),fe("div",{class:"container",ref_key:"containerRef",ref:n},[Ye("canvas",{id:"canvas",ref_key:"canvasReference",ref:s,width:500,height:500},null,512)],512))}});const Fe=xe(qe,[["__scopeId","data-v-00e31bbc"]]),Ze=e=>{const t=Y(null),o=()=>{t.value&&window.addEventListener("keydown",t.value)},n=()=>{t.value&&window.removeEventListener("keydown",t.value)};return Se(()=>{t.value=e}),Le(()=>{n()}),{addListener:o,removeListener:n}},$e=(e,t)=>{e.key==="Backspace"&&Xe(t)},Ve=e=>{if(!e.length)return"";const t=e.reduce((o,[n,r],s,i)=>{const[l,d]=i[(s+1)%i.length];return o.push(n,r,(n+l)/2,(r+d)/2),o},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")};function ve(e,t,o,n=r=>r){return e*n(.5-t*(.5-o))}function Ne(e){return[-e[0],-e[1]]}function k(e,t){return[e[0]+t[0],e[1]+t[1]]}function w(e,t){return[e[0]-t[0],e[1]-t[1]]}function _(e,t){return[e[0]*t,e[1]*t]}function Ke(e,t){return[e[0]/t,e[1]/t]}function W(e){return[e[1],-e[0]]}function Ce(e,t){return e[0]*t[0]+e[1]*t[1]}function Qe(e,t){return e[0]===t[0]&&e[1]===t[1]}function Ge(e){return Math.hypot(e[0],e[1])}function Je(e){return e[0]*e[0]+e[1]*e[1]}function we(e,t){return Je(w(e,t))}function Me(e){return Ke(e,Ge(e))}function et(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function I(e,t,o){let n=Math.sin(o),r=Math.cos(o),s=e[0]-t[0],i=e[1]-t[1],l=s*r-i*n,d=s*n+i*r;return[l+t[0],d+t[1]]}function ce(e,t,o){return k(e,_(w(t,e),o))}function _e(e,t,o){return k(e,_(t,o))}var{min:A,PI:tt}=Math,ke=.275,R=tt+1e-4;function nt(e,t={}){let{size:o=16,smoothing:n=.5,thinning:r=.5,simulatePressure:s=!0,easing:i=c=>c,start:l={},end:d={},last:f=!1}=t,{cap:j=!0,easing:a=c=>c*(2-c)}=l,{cap:b=!0,easing:u=c=>--c*c*c+1}=d;if(e.length===0||o<=0)return[];let g=e[e.length-1].runningLength,C=l.taper===!1?0:l.taper===!0?Math.max(o,g):l.taper,y=d.taper===!1?0:d.taper===!0?Math.max(o,g):d.taper,ge=Math.pow(o*n,2),X=[],D=[],G=e.slice(0,10).reduce((c,m)=>{let h=m.pressure;if(s){let p=A(1,m.distance/o),oe=A(1,1-p);h=A(1,c+(oe-c)*(p*ke))}return(c+h)/2},e[0].pressure),v=ve(o,r,e[e.length-1].pressure,i),J,ee=e[0].vector,z=e[0].point,U=z,M=z,P=U,te=!1;for(let c=0;c<e.length;c++){let{pressure:m}=e[c],{point:h,vector:p,distance:oe,runningLength:B}=e[c];if(c<e.length-1&&g-B<3)continue;if(r){if(s){let O=A(1,oe/o),re=A(1,1-O);m=A(1,G+(re-G)*(O*ke))}v=ve(o,r,m,i)}else v=o/2;J===void 0&&(J=v);let Pe=B<C?a(B/C):1,De=g-B<y?u((g-B)/y):1;v=Math.max(.01,v*Math.min(Pe,De));let pe=(c<e.length-1?e[c+1]:e[c]).vector,se=c<e.length-1?Ce(p,pe):1,Ae=Ce(p,ee)<0&&!te,be=se!==null&&se<0;if(Ae||be){let O=_(W(ee),v);for(let re=1/13,F=0;F<=1;F+=re)M=I(w(h,O),h,R*F),X.push(M),P=I(k(h,O),h,R*-F),D.push(P);z=M,U=P,be&&(te=!0);continue}if(te=!1,c===e.length-1){let O=_(W(p),v);X.push(w(h,O)),D.push(k(h,O));continue}let me=_(W(ce(pe,p,se)),v);M=w(h,me),(c<=1||we(z,M)>ge)&&(X.push(M),z=M),P=k(h,me),(c<=1||we(U,P)>ge)&&(D.push(P),U=P),G=m,ee=p}let S=e[0].point.slice(0,2),x=e.length>1?e[e.length-1].point.slice(0,2):k(e[0].point,[1,1]),ne=[],q=[];if(e.length===1){if(!(C||y)||f){let c=_e(S,Me(W(w(S,x))),-(J||v)),m=[];for(let h=1/13,p=h;p<=1;p+=h)m.push(I(c,S,R*2*p));return m}}else{if(!(C||y&&e.length===1))if(j)for(let m=1/13,h=m;h<=1;h+=m){let p=I(D[0],S,R*h);ne.push(p)}else{let m=w(X[0],D[0]),h=_(m,.5),p=_(m,.51);ne.push(w(S,h),w(S,p),k(S,p),k(S,h))}let c=W(Ne(e[e.length-1].vector));if(y||C&&e.length===1)q.push(x);else if(b){let m=_e(x,c,v);for(let h=1/29,p=h;p<1;p+=h)q.push(I(m,x,R*3*p))}else q.push(k(x,_(c,v)),k(x,_(c,v*.99)),w(x,_(c,v*.99)),w(x,_(c,v)))}return X.concat(q,D.reverse(),ne)}function ot(e,t={}){var o;let{streamline:n=.5,size:r=16,last:s=!1}=t;if(e.length===0)return[];let i=.15+(1-n)*.85,l=Array.isArray(e[0])?e:e.map(({x:u,y:g,pressure:C=.5})=>[u,g,C]);if(l.length===2){let u=l[1];l=l.slice(0,-1);for(let g=1;g<5;g++)l.push(ce(l[0],u,g/4))}l.length===1&&(l=[...l,[...k(l[0],[1,1]),...l[0].slice(2)]]);let d=[{point:[l[0][0],l[0][1]],pressure:l[0][2]>=0?l[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],f=!1,j=0,a=d[0],b=l.length-1;for(let u=1;u<l.length;u++){let g=s&&u===b?l[u].slice(0,2):ce(a.point,l[u],i);if(Qe(a.point,g))continue;let C=et(g,a.point);if(j+=C,u<b&&!f){if(j<r)continue;f=!0}a={point:g,pressure:l[u][2]>=0?l[u][2]:.5,vector:Me(w(a.point,g)),distance:C,runningLength:j},d.push(a)}return d[0].vector=((o=d[1])==null?void 0:o.vector)||[0,0],d}function st(e,t={}){return nt(ot(e,t),t)}var rt=st;let T="",Z=!1,ie=[[0,0]];const it=({canvas:e,drawingSettings:t})=>{if(!e){console.error("drawStrokeOnCanvas: canvas is null");return}e.on("mouse:down",o=>{Z=!0,T=he();const n=e.getPointer(o.e);ie=[[n.x,n.y]]}),e.on("mouse:move",o=>{if(!Z)return;e.discardActiveObject();const n=e.getPointer(o.e);ie.push([n.x,n.y]);const r=rt(ie,{size:t.size,thinning:t.thinning,smoothing:t.smoothing,streamline:t.streamline,easing(f){return f=Math.max(0,Math.min(1,f)),f*f*(3-2*f)}}),s=Ve(r),l=e.getObjects().filter(f=>(f==null?void 0:f.id)===T);if(l.length>0)for(let f=0;f<l.length;f++)e.remove(l[f]);const d=new L.fabric.Path(s,{scaleX:1,scaleY:1,cornerSize:6,evented:!1,selectable:!1,hasRotatingPoint:!1,fill:t.stroke});d.id=T,e.add(d)}),e.on("mouse:up",o=>{if(!Z)return;const r=e.getObjects().filter(s=>(s==null?void 0:s.id)===T);for(let s=0;s<r.length;s++){const i=r[s];i.setCoords(),e.add(i)}T="",Z=!1})},lt=(e,t)=>{if(e)return setTimeout(()=>e.requestRenderAll(),t)},at=({canvas:e,backgroundColor:t})=>{e&&e.setBackgroundColor(t,()=>lt(e,0))};let $=0,V=0,le=!1;const ct=({canvas:e})=>{e&&(e.on("mouse:down",t=>{var o,n,r;if(le=!0,t&&t.e&&t.e.type==="touchstart"){const s=t.e;$=(o=s==null?void 0:s.changedTouches[0])==null?void 0:o.clientX,V=(n=s==null?void 0:s.changedTouches[0])==null?void 0:n.clientY}(r=t.target)==null||r.setOptions({opacity:.5})}),e.on("mouse:move",t=>{if(!(!le||!t||!t.e||t.target)){if(t.e.type==="mousemove"){const o=new L.fabric.Point(t.e.movementX,t.e.movementY);e.relativePan(o)}if(t.e.type==="touchmove"){const o=t.e,n=o==null?void 0:o.touches[0];if(!n)return;const r=.9;let s=(n.clientX-$)*r,i=(n.clientY-V)*r;$=n.clientX,V=n.clientY;const l=new L.fabric.Point(s,i);e.relativePan(l)}}}),e.on("mouse:up",t=>{var o;le=!1,(o=t.target)==null||o.setOptions({opacity:1}),$=0,V=0}))};let N="",K=!1;const ut=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",function(o){K=!0,N=he();const n=e.getPointer(o.e),r=[n.x,n.y,n.x,n.y],s=new L.fabric.Line(r,{cornerSize:6,strokeWidth:3,cornerStyle:"circle",fill:t.stroke,stroke:t.stroke,originX:"center",originY:"center",evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1});s.id=N,e.add(s)}),e.on("mouse:move",o=>{if(!K)return;const n=e.getPointer(o.e),s=e.getObjects().filter(i=>(i==null?void 0:i.id)===N);for(let i=0;i<s.length;i++){const l=s[i];l==null||l.setOptions({x2:n.x,y2:n.y})}e.renderAll()}),e.on("mouse:up",o=>{if(!K)return;K=!1;const r=e.getObjects().filter(s=>(s==null?void 0:s.id)===N);for(let s=0;s<r.length;s++){const i=r[s];i.setCoords(),e.add(i)}}))},dt=e=>{var o;const t=(o=e.transform)==null?void 0:o.target;if(t){const n=t.scaleX||1,r=t.scaleY||1,s=t.width||1,i=t.height||1,l=s*n,d=i*r;t.set({width:l,height:d,scaleX:1,scaleY:1}),t.setCoords()}},ft=ze();let Q="",E=0,H=0,ae=!1;const ht=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{ae=!0;const n=e.getPointer(o.e);E=n.x,H=n.y;const r=new L.fabric.Rect({angle:0,top:H,left:E,evented:!1,originY:"top",originX:"left",selectable:!1,noScaleCache:!1,hasRotatingPoint:!1,width:n.x-E,height:n.y-H,rx:t.rx,ry:t.ry,cornerSize:6,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:Be({pasterns:ft,stroke:t.stroke,background:t.background})});r.on("scaling",s=>dt(s)),r.id=he(),Q=r.id,e.add(r).renderAll()}),e.on("mouse:move",o=>{if(!ae||!Q)return;const n=e.getPointer(o.e),s=e.getObjects().find(i=>i.id===Q);s&&(E>n.x&&s.set({left:Math.abs(n.x)}),H>n.y&&s.set({top:Math.abs(n.y)}),s.setOptions({width:Math.abs(E-n.x),height:Math.abs(H-n.y)}),e.renderAll())}),e.on("mouse:up",o=>{ae=!1;const r=e.getObjects().find(s=>s.id===Q);r&&(e.remove(r),r.setOptions({evented:!0,selectable:!0,hasRotatingPoint:!0}),r.setCoords(),e.add(r),e.setActiveObject(r))}))},je=e=>e==="drawing"||e==="panning"||e==="line",gt=e=>{if(!e){console.error("makeAllObjCanvasSelectable: canvas is null");return}e.selection=!0,e.forEachObject(t=>{t.setOptions({evented:!0,selectable:!0,hasControls:!0,hasRotatingPoint:!0})})},pt=e=>{if(!e){console.error("makeAllObjCanvasUnselectable: canvas is null");return}e.discardActiveObject(),e.selection=!1,e.forEachObject(t=>{t.setOptions({evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1})})},ye=e=>{e==null||e.off("mouse:up"),e==null||e.off("mouse:down"),e==null||e.off("mouse:move")},bt=ue({__name:"MainCanvas",setup(e){const t=We(),o=Ie(),n=Y(null),{addListener:r,removeListener:s}=Ze(a=>{const b=o.getSelectedCanvas;b&&$e(a,b)}),i=a=>{var u,g;if(console.log("double click",a),a.target&&a.target.type==="i-text"){a.target.enterEditing(),s();return}const b={y:((u=a.pointer)==null?void 0:u.y)||0,x:(((g=a.pointer)==null?void 0:g.x)||0)-100};Te({position:b,text:"Double click to edit text",canvas:o.getSelectedCanvas})},l=a=>{console.log("mouse down",a)},d=a=>{o.setSelectedCanvas({selectedCanvas:a})},f=a=>{console.log("selection",a),r(),t.setCanvasMode({canvasMode:"ObjContextMenu"})},j=a=>{t.setCanvasMode({canvasMode:"mainMenu"})};return Re(()=>({getCanvasMode:t.getCanvasMode,getIsDotBackground:t.getIsDotBackground,getSelectedCanvas:o.getSelectedCanvas,getDrawingSettings:o.getDrawingSettings,getSquareModeSettings:o.getSquareModeSettings}),a=>{const{getCanvasMode:b,getSelectedCanvas:u,getDrawingSettings:g,getIsDotBackground:C,getSquareModeSettings:y}=a;switch(ye(u),je(b)&&(console.log("unselectable"),pt(u)),je(b)||(console.log("selectable"),gt(u)),t.getCanvasMode){case"drawing":it({canvas:u,drawingSettings:g});break;case"panning":ct({canvas:u});break;case"square":ht({canvas:u,squareModeSettings:y});break;case"line":ut({canvas:u,squareModeSettings:y});break;default:ye(u);break}at({canvas:u,backgroundColor:C?Ee({}):"transparent"})}),(a,b)=>(de(),fe("div",{class:"design-canvas-container",ref_key:"elRef",ref:n},[Oe(Fe,{id:"1",onMouseDown:l,onMouseDblclick:i,onCanvasCreated:d,onSelectionCreated:f,onSelectionUpdated:f,onSelectionCleared:j})],512))}});const mt=xe(bt,[["__scopeId","data-v-e9a405e2"]]),Ct=ue({__name:"DesignView",setup(e){return(t,o)=>(de(),fe("main",null,[Oe(mt)]))}});export{Ct as default};
