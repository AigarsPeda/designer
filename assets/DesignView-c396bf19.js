import{d as ae,r as L,b as ye,f as R,o as ce,c as ue,a as Be,_ as Oe,e as Le,h as Re,g as Me,i as Ie,j as Ye,u as ze,k as We,w as Xe,l as xe,m as Ee,n as Fe}from"./index-4cffa95d.js";const Te=({canvas:e,containerRef:t})=>{const n=(t==null?void 0:t.offsetWidth)||500,o=(t==null?void 0:t.offsetHeight)||500;e==null||e.setDimensions({width:n,height:o})},Ue=({canvas:e})=>{e.on("mouse:wheel",t=>{const n=t.e.deltaY;let o=e.getZoom();o*=.999**n,o>20&&(o=20),o<.01&&(o=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},o),t.e.preventDefault(),t.e.stopPropagation()})},qe=ae({__name:"FabricCanvas",props:{id:{}},emits:["canvas-created","mouse-down","mouse-dblclick","selection-created","selection-cleared","selection-updated"],setup(e,{emit:t}){const n=L(null),o=L(null),s=L({width:0,height:0}),l=L(null);return ye(()=>{var r,g,k,y;const a=new R.fabric.Canvas(l.value,{preserveObjectStacking:!0,width:((r=o.value)==null?void 0:r.offsetWidth)||500,height:((g=o.value)==null?void 0:g.offsetHeight)||500});a&&(n.value=a,t("canvas-created",a),a.on("selection:created",i=>{t("selection-created",i)}),a.on("selection:updated",i=>{t("selection-updated",i)}),a.on("selection:cleared",i=>{t("selection-cleared",i)}),a.on("mouse:dblclick",i=>{t("mouse-dblclick",i)}),a.on("mouse:down:before",i=>{t("mouse-down",i)}),a.on("object:modified",i=>{var p;(p=i.target)==null||p.set({opacity:1}),a.renderAll()}),a.on("object:moving",i=>{var p;(p=i.target)==null||p.set({opacity:.75}),a.renderAll()}),s.value={width:((k=o.value)==null?void 0:k.offsetWidth)||500,height:((y=o.value)==null?void 0:y.offsetHeight)||500},Ue({canvas:a}),window.addEventListener("resize",()=>{Te({canvas:a,containerRef:o.value})}))}),(a,r)=>(ce(),ue("div",{class:"container",ref_key:"containerRef",ref:o},[Be("canvas",{id:"canvas",ref_key:"canvasReference",ref:l,width:500,height:500},null,512)],512))}});const He=Oe(qe,[["__scopeId","data-v-88f61db9"]]),Ve=e=>{const t=L(null),n=()=>{t.value&&window.addEventListener("keydown",t.value)},o=()=>{t.value&&window.removeEventListener("keydown",t.value)};return ye(()=>{t.value=e}),Le(()=>{o()}),{addListener:n,removeListener:o}},Ze=(e,t)=>{e.key==="Backspace"&&Re(t)},Se=e=>{if(!e){console.error("makeAllObjCanvasUnselectable: canvas is null");return}e.selection=!1,e.discardActiveObject(),e.forEachObject(t=>{t.setOptions({evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1})})},pe=e=>{e==null||e.off("mouse:up"),e==null||e.off("mouse:down"),e==null||e.off("mouse:move")},$e=e=>{if(!e.length)return"";const t=e.reduce((n,[o,s],l,a)=>{const[r,g]=a[(l+1)%a.length];return n.push(o,s,(o+r)/2,(s+g)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")};function be(e,t,n,o=s=>s){return e*o(.5-t*(.5-n))}function Ge(e){return[-e[0],-e[1]]}function w(e,t){return[e[0]+t[0],e[1]+t[1]]}function _(e,t){return[e[0]-t[0],e[1]-t[1]]}function C(e,t){return[e[0]*t,e[1]*t]}function Ke(e,t){return[e[0]/t,e[1]/t]}function W(e){return[e[1],-e[0]]}function me(e,t){return e[0]*t[0]+e[1]*t[1]}function Ne(e,t){return e[0]===t[0]&&e[1]===t[1]}function Qe(e){return Math.hypot(e[0],e[1])}function Je(e){return e[0]*e[0]+e[1]*e[1]}function ve(e,t){return Je(_(e,t))}function je(e){return Ke(e,Qe(e))}function et(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function X(e,t,n){let o=Math.sin(n),s=Math.cos(n),l=e[0]-t[0],a=e[1]-t[1],r=l*s-a*o,g=l*o+a*s;return[r+t[0],g+t[1]]}function le(e,t,n){return w(e,C(_(t,e),n))}function _e(e,t,n){return w(e,C(t,n))}var{min:A,PI:tt}=Math,Ce=.275,E=tt+1e-4;function nt(e,t={}){let{size:n=16,smoothing:o=.5,thinning:s=.5,simulatePressure:l=!0,easing:a=c=>c,start:r={},end:g={},last:k=!1}=t,{cap:y=!0,easing:i=c=>c*(2-c)}=r,{cap:p=!0,easing:u=c=>--c*c*c+1}=g;if(e.length===0||n<=0)return[];let f=e[e.length-1].runningLength,v=r.taper===!1?0:r.taper===!0?Math.max(n,f):r.taper,S=g.taper===!1?0:g.taper===!0?Math.max(n,f):g.taper,de=Math.pow(n*o,2),I=[],D=[],K=e.slice(0,10).reduce((c,b)=>{let d=b.pressure;if(l){let h=A(1,b.distance/n),te=A(1,1-h);d=A(1,c+(te-c)*(h*Ce))}return(c+d)/2},e[0].pressure),m=be(n,s,e[e.length-1].pressure,a),N,Q=e[0].vector,Y=e[0].point,U=Y,j=Y,P=U,J=!1;for(let c=0;c<e.length;c++){let{pressure:b}=e[c],{point:d,vector:h,distance:te,runningLength:z}=e[c];if(c<e.length-1&&f-z<3)continue;if(s){if(l){let x=A(1,te/n),oe=A(1,1-x);b=A(1,K+(oe-K)*(x*Ce))}m=be(n,s,b,a)}else m=n/2;N===void 0&&(N=m);let Pe=z<v?i(z/v):1,De=f-z<S?u((f-z)/S):1;m=Math.max(.01,m*Math.min(Pe,De));let fe=(c<e.length-1?e[c+1]:e[c]).vector,ne=c<e.length-1?me(h,fe):1,Ae=me(h,Q)<0&&!J,he=ne!==null&&ne<0;if(Ae||he){let x=C(W(Q),m);for(let oe=1/13,H=0;H<=1;H+=oe)j=X(_(d,x),d,E*H),I.push(j),P=X(w(d,x),d,E*-H),D.push(P);Y=j,U=P,he&&(J=!0);continue}if(J=!1,c===e.length-1){let x=C(W(h),m);I.push(_(d,x)),D.push(w(d,x));continue}let ge=C(W(le(fe,h,ne)),m);j=_(d,ge),(c<=1||ve(Y,j)>de)&&(I.push(j),Y=j),P=w(d,ge),(c<=1||ve(U,P)>de)&&(D.push(P),U=P),K=b,Q=h}let O=e[0].point.slice(0,2),M=e.length>1?e[e.length-1].point.slice(0,2):w(e[0].point,[1,1]),ee=[],q=[];if(e.length===1){if(!(v||S)||k){let c=_e(O,je(W(_(O,M))),-(N||m)),b=[];for(let d=1/13,h=d;h<=1;h+=d)b.push(X(c,O,E*2*h));return b}}else{if(!(v||S&&e.length===1))if(y)for(let b=1/13,d=b;d<=1;d+=b){let h=X(D[0],O,E*d);ee.push(h)}else{let b=_(I[0],D[0]),d=C(b,.5),h=C(b,.51);ee.push(_(O,d),_(O,h),w(O,h),w(O,d))}let c=W(Ge(e[e.length-1].vector));if(S||v&&e.length===1)q.push(M);else if(p){let b=_e(M,c,m);for(let d=1/29,h=d;h<1;h+=d)q.push(X(b,M,E*3*h))}else q.push(w(M,C(c,m)),w(M,C(c,m*.99)),_(M,C(c,m*.99)),_(M,C(c,m)))}return I.concat(q,D.reverse(),ee)}function ot(e,t={}){var n;let{streamline:o=.5,size:s=16,last:l=!1}=t;if(e.length===0)return[];let a=.15+(1-o)*.85,r=Array.isArray(e[0])?e:e.map(({x:u,y:f,pressure:v=.5})=>[u,f,v]);if(r.length===2){let u=r[1];r=r.slice(0,-1);for(let f=1;f<5;f++)r.push(le(r[0],u,f/4))}r.length===1&&(r=[...r,[...w(r[0],[1,1]),...r[0].slice(2)]]);let g=[{point:[r[0][0],r[0][1]],pressure:r[0][2]>=0?r[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],k=!1,y=0,i=g[0],p=r.length-1;for(let u=1;u<r.length;u++){let f=l&&u===p?r[u].slice(0,2):le(i.point,r[u],a);if(Ne(i.point,f))continue;let v=et(f,i.point);if(y+=v,u<p&&!k){if(y<s)continue;k=!0}i={point:f,pressure:r[u][2]>=0?r[u][2]:.5,vector:je(_(i.point,f)),distance:v,runningLength:y},g.push(i)}return g[0].vector=((n=g[1])==null?void 0:n.vector)||[0,0],g}function st(e,t={}){return nt(ot(e,t),t)}var rt=st;const we="drawnObjects";let V=!1,se=[[0,0]],B=null;const it=({canvas:e,drawingSettings:t})=>{if(!e){console.error("drawStrokeOnCanvas: canvas is null");return}e.on("mouse:down",n=>{V=!0,B=null;const o=e.getPointer(n.e);se=[[o.x,o.y]]}),e.on("mouse:move",n=>{if(!V)return;e.discardActiveObject();const o=e.getPointer(n.e);se.push([o.x,o.y]);const s=rt(se,{size:t.size,thinning:t.thinning,smoothing:t.smoothing,streamline:t.streamline,easing(a){return a=Math.max(0,Math.min(1,a)),a*a*(3-2*a)}}),l=$e(s);R.fabric.loadSVGFromString(`<svg>
         <path fill="${t.stroke}" d="${l}" />
      </svg>`,a=>{const r=new R.fabric.Group(a,{id:we,selectable:!1,hasRotatingPoint:!1});B=r,e.add(r)})}),e.on("mouse:up",n=>{if(!V)return;const s=e.getObjects().filter(l=>(l==null?void 0:l.id)===we);if(s.length>0&&B){for(let l=0;l<s.length;l++)e.remove(s[l]);B.setOptions({selectable:!0,id:Me(),hasRotatingPoint:!0}),B.bringForward(!0),e.add(B),e.renderAll()}Se(e),V=!1})},lt=(e,t)=>{if(e)return setTimeout(()=>e.requestRenderAll(),t)},at=({canvas:e,backgroundColor:t})=>{e&&e.setBackgroundColor(t,()=>lt(e,0))};let Z=0,$=0,re=!1;const ct=({canvas:e})=>{e&&(e.on("mouse:down",t=>{var n,o,s;if(re=!0,t&&t.e&&t.e.type==="touchstart"){const l=t.e;Z=(n=l==null?void 0:l.changedTouches[0])==null?void 0:n.clientX,$=(o=l==null?void 0:l.changedTouches[0])==null?void 0:o.clientY}(s=t.target)==null||s.setOptions({opacity:.5})}),e.on("mouse:move",t=>{if(!(!re||!t||!t.e||t.target)){if(t.e.type==="mousemove"){const n=new R.fabric.Point(t.e.movementX,t.e.movementY);e.relativePan(n)}if(t.e.type==="touchmove"){const n=t.e,o=n==null?void 0:n.touches[0];if(!o)return;const s=.9;let l=(o.clientX-Z)*s,a=(o.clientY-$)*s;Z=o.clientX,$=o.clientY;const r=new R.fabric.Point(l,a);e.relativePan(r)}}}),e.on("mouse:up",t=>{var n;re=!1,(n=t.target)==null||n.setOptions({opacity:1}),Z=0,$=0}))},ut=Ie();let G="",F=0,T=0,ie=!1;const dt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",n=>{ie=!0;const o=e.getPointer(n.e);F=o.x,T=o.y;const s=new R.fabric.Rect({angle:0,top:T,left:F,evented:!1,originY:"top",originX:"left",selectable:!1,hasRotatingPoint:!1,width:o.x-F,height:o.y-T,rx:t.rx,ry:t.ry,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:Ye({pasterns:ut,stroke:t.stroke,background:t.background})});s.id=Me(),G=s.id,e.add(s),e.renderAll()}),e.on("mouse:move",n=>{if(!ie||!G)return;const o=e.getPointer(n.e),l=e.getObjects().find(a=>a.id===G);l&&(F>o.x&&l.set({left:Math.abs(o.x)}),T>o.y&&l.set({top:Math.abs(o.y)}),l.setOptions({width:Math.abs(F-o.x),height:Math.abs(T-o.y)}),e.renderAll())}),e.on("mouse:up",n=>{ie=!1;const s=e.getObjects().find(l=>l.id===G);s&&(e.remove(s),s.setOptions({evented:!0,selectable:!0,hasRotatingPoint:!0}),s.setCoords(),e.add(s),e.setActiveObject(s))}))},ke=e=>e==="drawing"||e==="panning",ft=e=>{if(!e){console.error("makeAllObjCanvasSelectable: canvas is null");return}e.selection=!0,e.forEachObject(t=>{t.setOptions({evented:!0,selectable:!0,hasControls:!0,hasRotatingPoint:!0})})},ht=ae({__name:"MainCanvas",setup(e){const t=ze(),n=We(),o=L(null),{addListener:s,removeListener:l}=Ve(i=>{const p=n.getSelectedCanvas;p&&Ze(i,p)}),a=i=>{var u,f;if(console.log("double click",i),i.target&&i.target.type==="i-text"){i.target.enterEditing(),l();return}const p={y:((u=i.pointer)==null?void 0:u.y)||0,x:(((f=i.pointer)==null?void 0:f.x)||0)-100};Ee({position:p,text:"Double click to edit text",canvas:n.getSelectedCanvas})},r=i=>{console.log("mouse down",i)},g=i=>{n.setSelectedCanvas({selectedCanvas:i})},k=i=>{console.log("selection",i),s(),t.setCanvasMode({canvasMode:"ObjContextMenu"})},y=i=>{t.setCanvasMode({canvasMode:"mainMenu"})};return Xe(()=>({getCanvasMode:t.getCanvasMode,getIsDotBackground:t.getIsDotBackground,getSelectedCanvas:n.getSelectedCanvas,getDrawingSettings:n.getDrawingSettings,getSquareModeSettings:n.getSquareModeSettings}),i=>{const{getCanvasMode:p,getSelectedCanvas:u,getDrawingSettings:f,getIsDotBackground:v,getSquareModeSettings:S}=i;switch(pe(u),ke(p)&&Se(u),ke(p)||ft(u),t.getCanvasMode){case"drawing":it({canvas:u,drawingSettings:f});break;case"panning":ct({canvas:u});break;case"square":dt({canvas:u,squareModeSettings:S});break;default:pe(u);break}at({canvas:u,backgroundColor:v?Fe({}):"transparent"})}),(i,p)=>(ce(),ue("div",{class:"design-canvas-container",ref_key:"elRef",ref:o},[xe(He,{id:"1",onMouseDown:r,onMouseDblclick:a,onCanvasCreated:g,onSelectionCreated:k,onSelectionUpdated:k,onSelectionCleared:y})],512))}});const gt=Oe(ht,[["__scopeId","data-v-3ef4a1e4"]]),bt=ae({__name:"DesignView",setup(e){return(t,n)=>(ce(),ue("main",null,[xe(gt)]))}});export{bt as default};
