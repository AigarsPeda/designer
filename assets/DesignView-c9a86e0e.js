import{d as je,r as T,b as Ie,f as I,o as ve,c as ye,a as Te,_ as Le,e as We,h as Ee,g as V,i as Ne,j as Fe,s as Ue,u as $e,k as He,l as qe,w as Ze,m as ze,n as Ve,p as Je}from"./index-a5907fd1.js";const Ke=({canvas:e,containerRef:t})=>{const o=(t==null?void 0:t.offsetWidth)||500,n=(t==null?void 0:t.offsetHeight)||500;e==null||e.setDimensions({width:o,height:n})},Qe=({canvas:e})=>{e.on("mouse:wheel",t=>{const o=t.e.deltaY;let n=e.getZoom();n*=.999**o,n>20&&(n=20),n<.01&&(n=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},n),t.e.preventDefault(),t.e.stopPropagation()})},Ge=je({__name:"FabricCanvas",props:{id:{}},emits:["canvas-created","mouse-down","object-added","mouse-dblclick","object-removed","object-modified","selection-created","selection-cleared","selection-updated"],setup(e,{emit:t}){const o=T(null),n=T(null),r=T({width:0,height:0}),s=T(null);return Ie(()=>{var l,g,u,x;const i=new I.fabric.Canvas(s.value,{preserveObjectStacking:!0,width:((l=n.value)==null?void 0:l.offsetWidth)||500,height:((g=n.value)==null?void 0:g.offsetHeight)||500});i&&(o.value=i,t("canvas-created",i),i.on("selection:created",f=>{t("selection-created",f)}),i.on("selection:updated",f=>{t("selection-updated",f)}),i.on("selection:cleared",f=>{t("selection-cleared",f)}),i.on("mouse:dblclick",f=>{t("mouse-dblclick",f)}),i.on("mouse:down:before",f=>{t("mouse-down",f)}),i.on("object:added",f=>{t("object-added",f)}),i.on("object:removed",f=>{t("object-removed",f)}),i.on("object:modified",f=>{var v;t("object-modified",f),(v=f.target)==null||v.set({opacity:1}),i.renderAll()}),i.on("object:moving",f=>{var v;(v=f.target)==null||v.set({opacity:.75}),i.renderAll()}),r.value={width:((u=n.value)==null?void 0:u.offsetWidth)||500,height:((x=n.value)==null?void 0:x.offsetHeight)||500},Qe({canvas:i}),window.addEventListener("resize",()=>{Ke({canvas:i,containerRef:n.value})}))}),(i,l)=>(ve(),ye("div",{class:"container",ref_key:"containerRef",ref:n},[Te("canvas",{id:"canvas",ref_key:"canvasReference",ref:s,width:500,height:500},null,512)],512))}});const et=Le(Ge,[["__scopeId","data-v-0d76e339"]]),tt=e=>{const t=T(null),o=()=>{t.value&&window.addEventListener("keydown",t.value)},n=()=>{t.value&&window.removeEventListener("keydown",t.value)};return Ie(()=>{t.value=e}),We(()=>{n()}),{addListener:o,removeListener:n}},nt=(e,t)=>{e.key==="Backspace"&&Ee(t)},ot=e=>{if(!e.length)return"";const t=e.reduce((o,[n,r],s,i)=>{const[l,g]=i[(s+1)%i.length];return o.push(n,r,(n+l)/2,(r+g)/2),o},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")};function xe(e,t,o,n=r=>r){return e*n(.5-t*(.5-o))}function rt(e){return[-e[0],-e[1]]}function w(e,t){return[e[0]+t[0],e[1]+t[1]]}function M(e,t){return[e[0]-t[0],e[1]-t[1]]}function k(e,t){return[e[0]*t,e[1]*t]}function st(e,t){return[e[0]/t,e[1]/t]}function F(e){return[e[1],-e[0]]}function Se(e,t){return e[0]*t[0]+e[1]*t[1]}function it(e,t){return e[0]===t[0]&&e[1]===t[1]}function lt(e){return Math.hypot(e[0],e[1])}function at(e){return e[0]*e[0]+e[1]*e[1]}function _e(e,t){return at(M(e,t))}function Ye(e){return st(e,lt(e))}function ct(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function U(e,t,o){let n=Math.sin(o),r=Math.cos(o),s=e[0]-t[0],i=e[1]-t[1],l=s*r-i*n,g=s*n+i*r;return[l+t[0],g+t[1]]}function Ce(e,t,o){return w(e,k(M(t,e),o))}function Pe(e,t,o){return w(e,k(t,o))}var{min:R,PI:dt}=Math,Oe=.275,$=dt+1e-4;function ut(e,t={}){let{size:o=16,smoothing:n=.5,thinning:r=.5,simulatePressure:s=!0,easing:i=c=>c,start:l={},end:g={},last:u=!1}=t,{cap:x=!0,easing:f=c=>c*(2-c)}=l,{cap:v=!0,easing:a=c=>--c*c*c+1}=g;if(e.length===0||o<=0)return[];let d=e[e.length-1].runningLength,h=l.taper===!1?0:l.taper===!0?Math.max(o,d):l.taper,y=g.taper===!1?0:g.taper===!0?Math.max(o,d):g.taper,W=Math.pow(o*n,2),P=[],B=[],le=e.slice(0,10).reduce((c,m)=>{let p=m.pressure;if(s){let b=R(1,m.distance/o),fe=R(1,1-b);p=R(1,c+(fe-c)*(b*Oe))}return(c+p)/2},e[0].pressure),j=xe(o,r,e[e.length-1].pressure,i),ae,ce=e[0].vector,E=e[0].point,J=E,L=E,z=J,de=!1;for(let c=0;c<e.length;c++){let{pressure:m}=e[c],{point:p,vector:b,distance:fe,runningLength:N}=e[c];if(c<e.length-1&&d-N<3)continue;if(r){if(s){let D=R(1,fe/o),ge=R(1,1-D);m=R(1,le+(ge-le)*(D*Oe))}j=xe(o,r,m,i)}else j=o/2;ae===void 0&&(ae=j);let Xe=N<h?f(N/h):1,Be=d-N<y?a((d-N)/y):1;j=Math.max(.01,j*Math.min(Xe,Be));let Me=(c<e.length-1?e[c+1]:e[c]).vector,he=c<e.length-1?Se(b,Me):1,Re=Se(b,ce)<0&&!de,ke=he!==null&&he<0;if(Re||ke){let D=k(F(ce),j);for(let ge=1/13,Q=0;Q<=1;Q+=ge)L=U(M(p,D),p,$*Q),P.push(L),z=U(w(p,D),p,$*-Q),B.push(z);E=L,J=z,ke&&(de=!0);continue}if(de=!1,c===e.length-1){let D=k(F(b),j);P.push(M(p,D)),B.push(w(p,D));continue}let we=k(F(Ce(Me,b,he)),j);L=M(p,we),(c<=1||_e(E,L)>W)&&(P.push(L),E=L),z=w(p,we),(c<=1||_e(J,z)>W)&&(B.push(z),J=z),le=m,ce=b}let O=e[0].point.slice(0,2),A=e.length>1?e[e.length-1].point.slice(0,2):w(e[0].point,[1,1]),ue=[],K=[];if(e.length===1){if(!(h||y)||u){let c=Pe(O,Ye(F(M(O,A))),-(ae||j)),m=[];for(let p=1/13,b=p;b<=1;b+=p)m.push(U(c,O,$*2*b));return m}}else{if(!(h||y&&e.length===1))if(x)for(let m=1/13,p=m;p<=1;p+=m){let b=U(B[0],O,$*p);ue.push(b)}else{let m=M(P[0],B[0]),p=k(m,.5),b=k(m,.51);ue.push(M(O,p),M(O,b),w(O,b),w(O,p))}let c=F(rt(e[e.length-1].vector));if(y||h&&e.length===1)K.push(A);else if(v){let m=Pe(A,c,j);for(let p=1/29,b=p;b<1;b+=p)K.push(U(m,A,$*3*b))}else K.push(w(A,k(c,j)),w(A,k(c,j*.99)),M(A,k(c,j*.99)),M(A,k(c,j)))}return P.concat(K,B.reverse(),ue)}function ft(e,t={}){var o;let{streamline:n=.5,size:r=16,last:s=!1}=t;if(e.length===0)return[];let i=.15+(1-n)*.85,l=Array.isArray(e[0])?e:e.map(({x:a,y:d,pressure:h=.5})=>[a,d,h]);if(l.length===2){let a=l[1];l=l.slice(0,-1);for(let d=1;d<5;d++)l.push(Ce(l[0],a,d/4))}l.length===1&&(l=[...l,[...w(l[0],[1,1]),...l[0].slice(2)]]);let g=[{point:[l[0][0],l[0][1]],pressure:l[0][2]>=0?l[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],u=!1,x=0,f=g[0],v=l.length-1;for(let a=1;a<l.length;a++){let d=s&&a===v?l[a].slice(0,2):Ce(f.point,l[a],i);if(it(f.point,d))continue;let h=ct(d,f.point);if(x+=h,a<v&&!u){if(x<r)continue;u=!0}f={point:d,pressure:l[a][2]>=0?l[a][2]:.5,vector:Ye(M(f.point,d)),distance:h,runningLength:x},g.push(f)}return g[0].vector=((o=g[1])==null?void 0:o.vector)||[0,0],g}function ht(e,t={}){return ut(ft(e,t),t)}var gt=ht;const pt=e=>{if(!e){console.error("makeAllObjCanvasUnselectable: canvas is null");return}e.discardActiveObject(),e.selection=!1,e.forEachObject(t=>{t.setOptions({evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1})}),e.renderAll()};let H="",G=!1,pe=[[0,0]];const bt=({canvas:e,drawingSettings:t})=>{if(!e){console.error("drawStrokeOnCanvas: canvas is null");return}e.on("mouse:down",o=>{G=!0,H=V();const n=e.getPointer(o.e);pe=[[n.x,n.y]]}),e.on("mouse:move",o=>{if(!G)return;e.discardActiveObject();const n=e.getPointer(o.e);pe.push([n.x,n.y]);const r=gt(pe,{size:t.size,thinning:t.thinning,smoothing:t.smoothing,streamline:t.streamline,easing(u){return u=Math.max(0,Math.min(1,u)),u*u*(3-2*u)}}),s=ot(r),l=e.getObjects().filter(u=>(u==null?void 0:u.id)===H);if(l.length>0)for(let u=0;u<l.length;u++)e.remove(l[u]);const g=new I.fabric.Path(s,{scaleX:1,scaleY:1,cornerSize:6,evented:!1,selectable:!1,hasRotatingPoint:!1,fill:t.stroke});g.id=H,e.add(g)}),e.on("mouse:up",o=>{if(!G)return;const r=e.getObjects().filter(s=>(s==null?void 0:s.id)===H);for(let s=0;s<r.length;s++){const i=r[s];e.remove(i),i.setCoords(),e.add(i)}H="",G=!1})};let ee="",S=0,_=0,Y=0,X=0,te=!1;const C=5,mt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{te=!0,ee=V();const n=e.getPointer(o.e),r=[n.x,n.y,n.x,n.y];Y=n.x,X=n.y;const s=new I.fabric.Line(r,{cornerSize:6,strokeWidth:3,originX:"center",originY:"center",cornerStyle:"circle",fill:t.stroke,stroke:t.stroke,evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1});s.id=ee,e.add(s)}),e.on("mouse:move",o=>{if(!te)return;const n=e.getPointer(o.e),s=e.getObjects().filter(i=>(i==null?void 0:i.id)===ee);for(let i=0;i<s.length;i++){const l=s[i];l==null||l.setOptions({x2:n.x,y2:n.y})}e.renderAll()}),e.on("mouse:up",o=>{if(!te)return;te=!1;const n=e.getPointer(o.e);if(S=n.x,_=n.y,Y===S&&X===_)return;const r=Math.atan2(_-X,S-Y);S=S-C*Math.cos(r),_=_-C*Math.sin(r);const s=[{x:Y,y:X},{x:Y-C/4*Math.cos(r-Math.PI/2),y:X-C/4*Math.sin(r-Math.PI/2)},{x:S-C/4*Math.cos(r-Math.PI/2),y:_-C/4*Math.sin(r-Math.PI/2)},{x:S-C*Math.cos(r-Math.PI/2),y:_-C*Math.sin(r-Math.PI/2)},{x:S+C*2*Math.cos(r),y:_+C*2*Math.sin(r)},{x:S-C*Math.cos(r+Math.PI/2),y:_-C*Math.sin(r+Math.PI/2)},{x:S-C/4*Math.cos(r+Math.PI/2),y:_-C/4*Math.sin(r+Math.PI/2)},{x:Y-C/4*Math.cos(r+Math.PI/2),y:X-C/4*Math.sin(r+Math.PI/2)},{x:Y,y:X}],i=new I.fabric.Polyline(s,{opacity:1,cornerSize:6,evented:!0,selectable:!0,hasControls:!0,objectCaching:!1,hasRotatingPoint:!0,fill:t.stroke}),l=V();i.id=l,e.add(i),e.forEachObject(g=>{const u=g;u.id===ee&&e.remove(u),u.id===l&&(e.remove(u),u.setCoords(),e.add(u),e.setActiveObject(u))}),e.renderAll()}))},Ct=(e,t)=>{if(e)return setTimeout(()=>e.requestRenderAll(),t)},jt=({canvas:e,backgroundColor:t})=>{e&&e.setBackgroundColor(t,()=>Ct(e,0))};let ne=0,oe=0,be=!1;const vt=({canvas:e})=>{e&&(e.on("mouse:down",t=>{var o,n,r;if(be=!0,t&&t.e&&t.e.type==="touchstart"){const s=t.e;ne=(o=s==null?void 0:s.changedTouches[0])==null?void 0:o.clientX,oe=(n=s==null?void 0:s.changedTouches[0])==null?void 0:n.clientY}(r=t.target)==null||r.setOptions({opacity:.5})}),e.on("mouse:move",t=>{if(!(!be||!t||!t.e||t.target)){if(t.e.type==="mousemove"){const o=new I.fabric.Point(t.e.movementX,t.e.movementY);e.relativePan(o)}if(t.e.type==="touchmove"){const o=t.e,n=o==null?void 0:o.touches[0];if(!n)return;const r=.9;let s=(n.clientX-ne)*r,i=(n.clientY-oe)*r;ne=n.clientX,oe=n.clientY;const l=new I.fabric.Point(s,i);e.relativePan(l)}}}),e.on("mouse:up",t=>{var o;be=!1,(o=t.target)==null||o.setOptions({opacity:1}),ne=0,oe=0}))};let re="",se=!1;const yt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{se=!0,re=V();const n=e.getPointer(o.e),r=[n.x,n.y,n.x,n.y],s=new I.fabric.Line(r,{cornerSize:6,strokeWidth:3,cornerStyle:"circle",fill:t.stroke,stroke:t.stroke,originX:"center",originY:"center",evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1});s.id=re,e.add(s)}),e.on("mouse:move",o=>{if(!se)return;const n=e.getPointer(o.e),s=e.getObjects().filter(i=>(i==null?void 0:i.id)===re);for(let i=0;i<s.length;i++){const l=s[i];l==null||l.setOptions({x2:n.x,y2:n.y})}e.renderAll()}),e.on("mouse:up",()=>{if(!se)return;se=!1;const n=e.getObjects().filter(r=>(r==null?void 0:r.id)===re);for(let r=0;r<n.length;r++){const s=n[r];e.remove(s),s.setCoords(),e.add(s)}}))},Mt=Ne();let ie="",q=0,Z=0,me=!1;const kt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{me=!0;const n=e.getPointer(o.e);q=n.x,Z=n.y;const r=new I.fabric.Rect({angle:0,top:Z,left:q,evented:!1,originY:"top",originX:"left",selectable:!1,noScaleCache:!1,hasRotatingPoint:!1,width:n.x-q,height:n.y-Z,rx:t.rx,ry:t.ry,cornerSize:6,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:Fe({pasterns:Mt,stroke:t.stroke,background:t.background,isFindEnabled:t.backgroundPattern!=="none"})});r.on("scaling",s=>Ue(s)),r.id=V(),ie=r.id,e.add(r).renderAll()}),e.on("mouse:move",o=>{if(!me||!ie)return;const n=e.getPointer(o.e),s=e.getObjects().find(i=>i.id===ie);s&&(q>n.x&&s.set({left:Math.abs(n.x)}),Z>n.y&&s.set({top:Math.abs(n.y)}),s.setOptions({width:Math.abs(q-n.x),height:Math.abs(Z-n.y)}),e.renderAll())}),e.on("mouse:up",o=>{me=!1;const r=e.getObjects().find(s=>s.id===ie);r&&(e.remove(r),r.setOptions({evented:!0,selectable:!0,hasRotatingPoint:!0}),r.setCoords(),e.add(r),e.setActiveObject(r))}))},Ae=e=>e==="drawing"||e==="panning"||e==="line"||e==="arrow",wt=e=>{if(!e){console.error("makeAllObjCanvasSelectable: canvas is null");return}e.selection=!0,e.forEachObject(t=>{t.setOptions({evented:!0,selectable:!0,hasControls:!0,hasRotatingPoint:!0})}),e.renderAll()},De=e=>{e==null||e.off("mouse:up"),e==null||e.off("mouse:down"),e==null||e.off("mouse:move")},xt=je({__name:"MainCanvas",setup(e){const t=$e(),o=He(),n=T(null),{storedCanvasSate:r,addCanvasStateToLocalStorage:s}=qe(),i=()=>{const a=o.getSelectedCanvas;if(!a)return;const d=a.toJSON();s({state:d,name:t.getSelectedCanvasName})},{addListener:l,removeListener:g}=tt(a=>{const d=o.getSelectedCanvas;d&&nt(a,d)}),u=a=>{var h,y;if(console.log("double click",a),a.target&&a.target.type==="i-text"){a.target.enterEditing(),g();return}const d={y:((h=a.pointer)==null?void 0:h.y)||0,x:(((y=a.pointer)==null?void 0:y.x)||0)-100};Ve({position:d,text:"Double click to edit text",canvas:o.getSelectedCanvas})},x=a=>{const d=r;if(d&&d[t.getSelectedCanvasName]){const h=d[t.getSelectedCanvasName].length,y=d[t.getSelectedCanvasName][h-1];a.loadFromJSON(y,a.renderAll.bind(a)),o.setSelectedCanvas({selectedCanvas:a});return}o.setSelectedCanvas({selectedCanvas:a})},f=a=>{console.log("selection",a),l(),t.setCanvasMode({canvasMode:"ObjContextMenu"})},v=a=>{t.setCanvasMode({canvasMode:"mainMenu"})};return Ze(()=>({getCanvasMode:t.getCanvasMode,getIsDotBackground:t.getIsDotBackground,getSelectedCanvas:o.getSelectedCanvas,getDrawingSettings:o.getDrawingSettings,getSquareModeSettings:o.getSquareModeSettings}),a=>{const{getCanvasMode:d,getSelectedCanvas:h,getDrawingSettings:y,getIsDotBackground:W,getSquareModeSettings:P}=a;switch(De(h),Ae(d)&&pt(h),Ae(d)||wt(h),t.getCanvasMode){case"drawing":bt({canvas:h,drawingSettings:y});break;case"panning":vt({canvas:h});break;case"square":kt({canvas:h,squareModeSettings:P});break;case"line":yt({canvas:h,squareModeSettings:P});break;case"arrow":mt({canvas:h,squareModeSettings:P});break;default:De(h);break}jt({canvas:h,backgroundColor:W?Je({}):"transparent"})}),(a,d)=>(ve(),ye("div",{class:"design-canvas-container",ref_key:"elRef",ref:n},[ze(et,{id:"1",onMouseDblclick:u,onCanvasCreated:x,onSelectionCreated:f,onSelectionUpdated:f,onObjectAdded:i,onObjectRemoved:i,onObjectModified:i,onSelectionCleared:v})],512))}});const St=Le(xt,[["__scopeId","data-v-7d6b17d1"]]),Pt=je({__name:"DesignView",setup(e){return(t,o)=>(ve(),ye("main",null,[ze(St)]))}});export{Pt as default};
