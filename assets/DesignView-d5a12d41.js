import{d as ae,r as B,b as ye,f as L,o as ce,c as ue,a as Ye,_ as Oe,e as Be,h as Le,g as Me,i as Xe,j as Re,u as We,k as ze,w as Ie,l as Se,m as Ee,n as Fe}from"./index-c0c3d959.js";const He=({canvas:e,containerRef:t})=>{const n=(t==null?void 0:t.offsetWidth)||500,o=(t==null?void 0:t.offsetHeight)||500;e==null||e.setDimensions({width:n,height:o})},Te=({canvas:e})=>{e.on("mouse:wheel",t=>{const n=t.e.deltaY;let o=e.getZoom();o*=.999**n,o>20&&(o=20),o<.01&&(o=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},o),t.e.preventDefault(),t.e.stopPropagation()})},Ue=ae({__name:"FabricCanvas",props:{id:{}},emits:["canvas-created","mouse-down","mouse-dblclick","selection-created","selection-cleared","selection-updated"],setup(e,{emit:t}){const n=B(null),o=B(null),s=B({width:0,height:0}),r=B(null);return ye(()=>{var i,f,k,y;const l=new L.fabric.Canvas(r.value,{preserveObjectStacking:!0,width:((i=o.value)==null?void 0:i.offsetWidth)||500,height:((f=o.value)==null?void 0:f.offsetHeight)||500});l&&(n.value=l,t("canvas-created",l),l.on("selection:created",a=>{t("selection-created",a)}),l.on("selection:updated",a=>{t("selection-updated",a)}),l.on("selection:cleared",a=>{t("selection-cleared",a)}),l.on("mouse:dblclick",a=>{t("mouse-dblclick",a)}),l.on("mouse:down:before",a=>{t("mouse-down",a)}),l.on("object:modified",a=>{var p;(p=a.target)==null||p.set({opacity:1}),l.renderAll()}),l.on("object:moving",a=>{var p;(p=a.target)==null||p.set({opacity:.75}),l.renderAll()}),s.value={width:((k=o.value)==null?void 0:k.offsetWidth)||500,height:((y=o.value)==null?void 0:y.offsetHeight)||500},Te({canvas:l}),window.addEventListener("resize",()=>{He({canvas:l,containerRef:o.value})}))}),(l,i)=>(ce(),ue("div",{class:"container",ref_key:"containerRef",ref:o},[Ye("canvas",{id:"canvas",ref_key:"canvasReference",ref:r,width:500,height:500},null,512)],512))}});const qe=Oe(Ue,[["__scopeId","data-v-00e31bbc"]]),Ve=e=>{const t=B(null),n=()=>{t.value&&window.addEventListener("keydown",t.value)},o=()=>{t.value&&window.removeEventListener("keydown",t.value)};return ye(()=>{t.value=e}),Be(()=>{o()}),{addListener:n,removeListener:o}},Ze=(e,t)=>{e.key==="Backspace"&&Le(t)},je=e=>{if(!e){console.error("makeAllObjCanvasUnselectable: canvas is null");return}e.selection=!1,e.discardActiveObject(),e.forEachObject(t=>{t.setOptions({evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1})})},pe=e=>{e==null||e.off("mouse:up"),e==null||e.off("mouse:down"),e==null||e.off("mouse:move")},$e=e=>{if(!e.length)return"";const t=e.reduce((n,[o,s],r,l)=>{const[i,f]=l[(r+1)%l.length];return n.push(o,s,(o+i)/2,(s+f)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")};function be(e,t,n,o=s=>s){return e*o(.5-t*(.5-n))}function Ge(e){return[-e[0],-e[1]]}function w(e,t){return[e[0]+t[0],e[1]+t[1]]}function C(e,t){return[e[0]-t[0],e[1]-t[1]]}function _(e,t){return[e[0]*t,e[1]*t]}function Ke(e,t){return[e[0]/t,e[1]/t]}function z(e){return[e[1],-e[0]]}function me(e,t){return e[0]*t[0]+e[1]*t[1]}function Ne(e,t){return e[0]===t[0]&&e[1]===t[1]}function Qe(e){return Math.hypot(e[0],e[1])}function Je(e){return e[0]*e[0]+e[1]*e[1]}function ve(e,t){return Je(C(e,t))}function xe(e){return Ke(e,Qe(e))}function et(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function I(e,t,n){let o=Math.sin(n),s=Math.cos(n),r=e[0]-t[0],l=e[1]-t[1],i=r*s-l*o,f=r*o+l*s;return[i+t[0],f+t[1]]}function le(e,t,n){return w(e,_(C(t,e),n))}function Ce(e,t,n){return w(e,_(t,n))}var{min:A,PI:tt}=Math,_e=.275,E=tt+1e-4;function nt(e,t={}){let{size:n=16,smoothing:o=.5,thinning:s=.5,simulatePressure:r=!0,easing:l=c=>c,start:i={},end:f={},last:k=!1}=t,{cap:y=!0,easing:a=c=>c*(2-c)}=i,{cap:p=!0,easing:u=c=>--c*c*c+1}=f;if(e.length===0||n<=0)return[];let h=e[e.length-1].runningLength,v=i.taper===!1?0:i.taper===!0?Math.max(n,h):i.taper,j=f.taper===!1?0:f.taper===!0?Math.max(n,h):f.taper,de=Math.pow(n*o,2),X=[],D=[],K=e.slice(0,10).reduce((c,b)=>{let d=b.pressure;if(r){let g=A(1,b.distance/n),te=A(1,1-g);d=A(1,c+(te-c)*(g*_e))}return(c+d)/2},e[0].pressure),m=be(n,s,e[e.length-1].pressure,l),N,Q=e[0].vector,R=e[0].point,T=R,x=R,P=T,J=!1;for(let c=0;c<e.length;c++){let{pressure:b}=e[c],{point:d,vector:g,distance:te,runningLength:W}=e[c];if(c<e.length-1&&h-W<3)continue;if(s){if(r){let S=A(1,te/n),oe=A(1,1-S);b=A(1,K+(oe-K)*(S*_e))}m=be(n,s,b,l)}else m=n/2;N===void 0&&(N=m);let Pe=W<v?a(W/v):1,De=h-W<j?u((h-W)/j):1;m=Math.max(.01,m*Math.min(Pe,De));let fe=(c<e.length-1?e[c+1]:e[c]).vector,ne=c<e.length-1?me(g,fe):1,Ae=me(g,Q)<0&&!J,he=ne!==null&&ne<0;if(Ae||he){let S=_(z(Q),m);for(let oe=1/13,q=0;q<=1;q+=oe)x=I(C(d,S),d,E*q),X.push(x),P=I(w(d,S),d,E*-q),D.push(P);R=x,T=P,he&&(J=!0);continue}if(J=!1,c===e.length-1){let S=_(z(g),m);X.push(C(d,S)),D.push(w(d,S));continue}let ge=_(z(le(fe,g,ne)),m);x=C(d,ge),(c<=1||ve(R,x)>de)&&(X.push(x),R=x),P=w(d,ge),(c<=1||ve(T,P)>de)&&(D.push(P),T=P),K=b,Q=g}let O=e[0].point.slice(0,2),M=e.length>1?e[e.length-1].point.slice(0,2):w(e[0].point,[1,1]),ee=[],U=[];if(e.length===1){if(!(v||j)||k){let c=Ce(O,xe(z(C(O,M))),-(N||m)),b=[];for(let d=1/13,g=d;g<=1;g+=d)b.push(I(c,O,E*2*g));return b}}else{if(!(v||j&&e.length===1))if(y)for(let b=1/13,d=b;d<=1;d+=b){let g=I(D[0],O,E*d);ee.push(g)}else{let b=C(X[0],D[0]),d=_(b,.5),g=_(b,.51);ee.push(C(O,d),C(O,g),w(O,g),w(O,d))}let c=z(Ge(e[e.length-1].vector));if(j||v&&e.length===1)U.push(M);else if(p){let b=Ce(M,c,m);for(let d=1/29,g=d;g<1;g+=d)U.push(I(b,M,E*3*g))}else U.push(w(M,_(c,m)),w(M,_(c,m*.99)),C(M,_(c,m*.99)),C(M,_(c,m)))}return X.concat(U,D.reverse(),ee)}function ot(e,t={}){var n;let{streamline:o=.5,size:s=16,last:r=!1}=t;if(e.length===0)return[];let l=.15+(1-o)*.85,i=Array.isArray(e[0])?e:e.map(({x:u,y:h,pressure:v=.5})=>[u,h,v]);if(i.length===2){let u=i[1];i=i.slice(0,-1);for(let h=1;h<5;h++)i.push(le(i[0],u,h/4))}i.length===1&&(i=[...i,[...w(i[0],[1,1]),...i[0].slice(2)]]);let f=[{point:[i[0][0],i[0][1]],pressure:i[0][2]>=0?i[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],k=!1,y=0,a=f[0],p=i.length-1;for(let u=1;u<i.length;u++){let h=r&&u===p?i[u].slice(0,2):le(a.point,i[u],l);if(Ne(a.point,h))continue;let v=et(h,a.point);if(y+=v,u<p&&!k){if(y<s)continue;k=!0}a={point:h,pressure:i[u][2]>=0?i[u][2]:.5,vector:xe(C(a.point,h)),distance:v,runningLength:y},f.push(a)}return f[0].vector=((n=f[1])==null?void 0:n.vector)||[0,0],f}function st(e,t={}){return nt(ot(e,t),t)}var rt=st;const we="drawnObjects";let V=!1,se=[[0,0]],Y=null;const it=({canvas:e,drawingSettings:t})=>{if(!e){console.error("drawStrokeOnCanvas: canvas is null");return}e.on("mouse:down",n=>{V=!0,Y=null;const o=e.getPointer(n.e);se=[[o.x,o.y]]}),e.on("mouse:move",n=>{if(!V)return;e.discardActiveObject();const o=e.getPointer(n.e);se.push([o.x,o.y]);const s=rt(se,{size:t.size,thinning:t.thinning,smoothing:t.smoothing,streamline:t.streamline,easing(l){return l=Math.max(0,Math.min(1,l)),l*l*(3-2*l)}}),r=$e(s);L.fabric.loadSVGFromString(`<svg>
         <path fill="${t.stroke}" d="${r}" />
      </svg>`,l=>{const i=new L.fabric.Group(l,{id:we,selectable:!1,hasRotatingPoint:!1});Y=i,e.add(i)})}),e.on("mouse:up",n=>{if(!V)return;const s=e.getObjects().filter(r=>(r==null?void 0:r.id)===we);if(s.length>0&&Y){for(let r=0;r<s.length;r++)e.remove(s[r]);Y.setOptions({selectable:!0,id:Me(),hasRotatingPoint:!0}),Y.bringForward(!0),e.add(Y),e.renderAll()}je(e),V=!1})},lt=(e,t)=>{if(e)return setTimeout(()=>e.requestRenderAll(),t)},at=({canvas:e,backgroundColor:t})=>{e&&e.setBackgroundColor(t,()=>lt(e,0))};let Z=0,$=0,re=!1;const ct=({canvas:e})=>{e&&(e.on("mouse:down",t=>{var n,o,s;if(re=!0,t&&t.e&&t.e.type==="touchstart"){const r=t.e;Z=(n=r==null?void 0:r.changedTouches[0])==null?void 0:n.clientX,$=(o=r==null?void 0:r.changedTouches[0])==null?void 0:o.clientY}(s=t.target)==null||s.setOptions({opacity:.5})}),e.on("mouse:move",t=>{if(!(!re||!t||!t.e||t.target)){if(t.e.type==="mousemove"){const n=new L.fabric.Point(t.e.movementX,t.e.movementY);e.relativePan(n)}if(t.e.type==="touchmove"){const n=t.e,o=n==null?void 0:n.touches[0];if(!o)return;const s=.9;let r=(o.clientX-Z)*s,l=(o.clientY-$)*s;Z=o.clientX,$=o.clientY;const i=new L.fabric.Point(r,l);e.relativePan(i)}}}),e.on("mouse:up",t=>{var n;re=!1,(n=t.target)==null||n.setOptions({opacity:1}),Z=0,$=0}))},ut=e=>{var n;const t=(n=e.transform)==null?void 0:n.target;if(t){const o=t.scaleX||1,s=t.scaleY||1,r=t.width||1,l=t.height||1,i=r*o,f=l*s;t.set({width:i,height:f,scaleX:1,scaleY:1}),t.setCoords()}},dt=Xe();let G="",F=0,H=0,ie=!1;const ft=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",n=>{ie=!0;const o=e.getPointer(n.e);F=o.x,H=o.y;const s=new L.fabric.Rect({angle:0,top:H,left:F,evented:!1,originY:"top",originX:"left",selectable:!1,noScaleCache:!1,hasRotatingPoint:!1,width:o.x-F,height:o.y-H,rx:t.rx,ry:t.ry,cornerSize:6,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:Re({pasterns:dt,stroke:t.stroke,background:t.background})});s.on("scaling",r=>ut(r)),s.id=Me(),G=s.id,e.add(s).renderAll()}),e.on("mouse:move",n=>{if(!ie||!G)return;const o=e.getPointer(n.e),r=e.getObjects().find(l=>l.id===G);r&&(F>o.x&&r.set({left:Math.abs(o.x)}),H>o.y&&r.set({top:Math.abs(o.y)}),r.setOptions({width:Math.abs(F-o.x),height:Math.abs(H-o.y)}),e.renderAll())}),e.on("mouse:up",n=>{ie=!1;const s=e.getObjects().find(r=>r.id===G);s&&(e.remove(s),s.setOptions({evented:!0,selectable:!0,hasRotatingPoint:!0}),s.setCoords(),e.add(s),e.setActiveObject(s))}))},ke=e=>e==="drawing"||e==="panning",ht=e=>{if(!e){console.error("makeAllObjCanvasSelectable: canvas is null");return}e.selection=!0,e.forEachObject(t=>{t.setOptions({evented:!0,selectable:!0,hasControls:!0,hasRotatingPoint:!0})})},gt=ae({__name:"MainCanvas",setup(e){const t=We(),n=ze(),o=B(null),{addListener:s,removeListener:r}=Ve(a=>{const p=n.getSelectedCanvas;p&&Ze(a,p)}),l=a=>{var u,h;if(console.log("double click",a),a.target&&a.target.type==="i-text"){a.target.enterEditing(),r();return}const p={y:((u=a.pointer)==null?void 0:u.y)||0,x:(((h=a.pointer)==null?void 0:h.x)||0)-100};Ee({position:p,text:"Double click to edit text",canvas:n.getSelectedCanvas})},i=a=>{console.log("mouse down",a)},f=a=>{n.setSelectedCanvas({selectedCanvas:a})},k=a=>{console.log("selection",a),s(),t.setCanvasMode({canvasMode:"ObjContextMenu"})},y=a=>{t.setCanvasMode({canvasMode:"mainMenu"})};return Ie(()=>({getCanvasMode:t.getCanvasMode,getIsDotBackground:t.getIsDotBackground,getSelectedCanvas:n.getSelectedCanvas,getDrawingSettings:n.getDrawingSettings,getSquareModeSettings:n.getSquareModeSettings}),a=>{const{getCanvasMode:p,getSelectedCanvas:u,getDrawingSettings:h,getIsDotBackground:v,getSquareModeSettings:j}=a;switch(pe(u),ke(p)&&je(u),ke(p)||ht(u),t.getCanvasMode){case"drawing":it({canvas:u,drawingSettings:h});break;case"panning":ct({canvas:u});break;case"square":ft({canvas:u,squareModeSettings:j});break;default:pe(u);break}at({canvas:u,backgroundColor:v?Fe({}):"transparent"})}),(a,p)=>(ce(),ue("div",{class:"design-canvas-container",ref_key:"elRef",ref:o},[Se(qe,{id:"1",onMouseDown:i,onMouseDblclick:l,onCanvasCreated:f,onSelectionCreated:k,onSelectionUpdated:k,onSelectionCleared:y})],512))}});const pt=Oe(gt,[["__scopeId","data-v-3ef4a1e4"]]),mt=ae({__name:"DesignView",setup(e){return(t,n)=>(ce(),ue("main",null,[Se(pt)]))}});export{mt as default};
