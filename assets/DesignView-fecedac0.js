import{d as we,r as W,b as Ie,f as D,o as ye,c as Me,a as Re,_ as Ye,e as Te,h as Ee,g as V,i as He,j as Ue,u as $e,k as qe,w as Fe,l as Le,m as Ze,n as Ve}from"./index-67eec9af.js";const Ne=({canvas:e,containerRef:t})=>{const o=(t==null?void 0:t.offsetWidth)||500,n=(t==null?void 0:t.offsetHeight)||500;e==null||e.setDimensions({width:o,height:n})},Ke=({canvas:e})=>{e.on("mouse:wheel",t=>{const o=t.e.deltaY;let n=e.getZoom();n*=.999**o,n>20&&(n=20),n<.01&&(n=.01),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},n),t.e.preventDefault(),t.e.stopPropagation()})},Qe=we({__name:"FabricCanvas",props:{id:{}},emits:["canvas-created","mouse-down","mouse-dblclick","selection-created","selection-cleared","selection-updated"],setup(e,{emit:t}){const o=W(null),n=W(null),s=W({width:0,height:0}),r=W(null);return Ie(()=>{var l,h,u,j;const i=new D.fabric.Canvas(r.value,{preserveObjectStacking:!0,width:((l=n.value)==null?void 0:l.offsetWidth)||500,height:((h=n.value)==null?void 0:h.offsetHeight)||500});i&&(o.value=i,t("canvas-created",i),i.on("selection:created",a=>{t("selection-created",a)}),i.on("selection:updated",a=>{t("selection-updated",a)}),i.on("selection:cleared",a=>{t("selection-cleared",a)}),i.on("mouse:dblclick",a=>{t("mouse-dblclick",a)}),i.on("mouse:down:before",a=>{t("mouse-down",a)}),i.on("object:modified",a=>{var b;(b=a.target)==null||b.set({opacity:1}),i.renderAll()}),i.on("object:moving",a=>{var b;(b=a.target)==null||b.set({opacity:.75}),i.renderAll()}),s.value={width:((u=n.value)==null?void 0:u.offsetWidth)||500,height:((j=n.value)==null?void 0:j.offsetHeight)||500},Ke({canvas:i}),window.addEventListener("resize",()=>{Ne({canvas:i,containerRef:n.value})}))}),(i,l)=>(ye(),Me("div",{class:"container",ref_key:"containerRef",ref:n},[Re("canvas",{id:"canvas",ref_key:"canvasReference",ref:r,width:500,height:500},null,512)],512))}});const Ge=Ye(Qe,[["__scopeId","data-v-00e31bbc"]]),Je=e=>{const t=W(null),o=()=>{t.value&&window.addEventListener("keydown",t.value)},n=()=>{t.value&&window.removeEventListener("keydown",t.value)};return Ie(()=>{t.value=e}),Te(()=>{n()}),{addListener:o,removeListener:n}},et=(e,t)=>{e.key==="Backspace"&&Ee(t)},tt=e=>{if(!e.length)return"";const t=e.reduce((o,[n,s],r,i)=>{const[l,h]=i[(r+1)%i.length];return o.push(n,s,(n+l)/2,(s+h)/2),o},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")};function _e(e,t,o,n=s=>s){return e*n(.5-t*(.5-o))}function nt(e){return[-e[0],-e[1]]}function x(e,t){return[e[0]+t[0],e[1]+t[1]]}function C(e,t){return[e[0]-t[0],e[1]-t[1]]}function k(e,t){return[e[0]*t,e[1]*t]}function ot(e,t){return[e[0]/t,e[1]/t]}function H(e){return[e[1],-e[0]]}function ve(e,t){return e[0]*t[0]+e[1]*t[1]}function st(e,t){return e[0]===t[0]&&e[1]===t[1]}function rt(e){return Math.hypot(e[0],e[1])}function it(e){return e[0]*e[0]+e[1]*e[1]}function Pe(e,t){return it(C(e,t))}function Xe(e){return ot(e,rt(e))}function lt(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function U(e,t,o){let n=Math.sin(o),s=Math.cos(o),r=e[0]-t[0],i=e[1]-t[1],l=r*s-i*n,h=r*n+i*s;return[l+t[0],h+t[1]]}function me(e,t,o){return x(e,k(C(t,e),o))}function Oe(e,t,o){return x(e,k(t,o))}var{min:B,PI:at}=Math,Se=.275,$=at+1e-4;function ct(e,t={}){let{size:o=16,smoothing:n=.5,thinning:s=.5,simulatePressure:r=!0,easing:i=c=>c,start:l={},end:h={},last:u=!1}=t,{cap:j=!0,easing:a=c=>c*(2-c)}=l,{cap:b=!0,easing:d=c=>--c*c*c+1}=h;if(e.length===0||o<=0)return[];let g=e[e.length-1].runningLength,M=l.taper===!1?0:l.taper===!0?Math.max(o,g):l.taper,P=h.taper===!1?0:h.taper===!0?Math.max(o,g):h.taper,Ce=Math.pow(o*n,2),R=[],z=[],ie=e.slice(0,10).reduce((c,m)=>{let f=m.pressure;if(r){let p=B(1,m.distance/o),de=B(1,1-p);f=B(1,c+(de-c)*(p*Se))}return(c+f)/2},e[0].pressure),y=_e(o,s,e[e.length-1].pressure,i),le,ae=e[0].vector,T=e[0].point,N=T,I=T,Y=N,ce=!1;for(let c=0;c<e.length;c++){let{pressure:m}=e[c],{point:f,vector:p,distance:de,runningLength:E}=e[c];if(c<e.length-1&&g-E<3)continue;if(s){if(r){let A=B(1,de/o),fe=B(1,1-A);m=B(1,ie+(fe-ie)*(A*Se))}y=_e(o,s,m,i)}else y=o/2;le===void 0&&(le=y);let ze=E<M?a(E/M):1,Be=g-E<P?d((g-E)/P):1;y=Math.max(.01,y*Math.min(ze,Be));let ke=(c<e.length-1?e[c+1]:e[c]).vector,he=c<e.length-1?ve(p,ke):1,We=ve(p,ae)<0&&!ce,xe=he!==null&&he<0;if(We||xe){let A=k(H(ae),y);for(let fe=1/13,Q=0;Q<=1;Q+=fe)I=U(C(f,A),f,$*Q),R.push(I),Y=U(x(f,A),f,$*-Q),z.push(Y);T=I,N=Y,xe&&(ce=!0);continue}if(ce=!1,c===e.length-1){let A=k(H(p),y);R.push(C(f,A)),z.push(x(f,A));continue}let je=k(H(me(ke,p,he)),y);I=C(f,je),(c<=1||Pe(T,I)>Ce)&&(R.push(I),T=I),Y=x(f,je),(c<=1||Pe(N,Y)>Ce)&&(z.push(Y),N=Y),ie=m,ae=p}let O=e[0].point.slice(0,2),S=e.length>1?e[e.length-1].point.slice(0,2):x(e[0].point,[1,1]),ue=[],K=[];if(e.length===1){if(!(M||P)||u){let c=Oe(O,Xe(H(C(O,S))),-(le||y)),m=[];for(let f=1/13,p=f;p<=1;p+=f)m.push(U(c,O,$*2*p));return m}}else{if(!(M||P&&e.length===1))if(j)for(let m=1/13,f=m;f<=1;f+=m){let p=U(z[0],O,$*f);ue.push(p)}else{let m=C(R[0],z[0]),f=k(m,.5),p=k(m,.51);ue.push(C(O,f),C(O,p),x(O,p),x(O,f))}let c=H(nt(e[e.length-1].vector));if(P||M&&e.length===1)K.push(S);else if(b){let m=Oe(S,c,y);for(let f=1/29,p=f;p<1;p+=f)K.push(U(m,S,$*3*p))}else K.push(x(S,k(c,y)),x(S,k(c,y*.99)),C(S,k(c,y*.99)),C(S,k(c,y)))}return R.concat(K,z.reverse(),ue)}function ut(e,t={}){var o;let{streamline:n=.5,size:s=16,last:r=!1}=t;if(e.length===0)return[];let i=.15+(1-n)*.85,l=Array.isArray(e[0])?e:e.map(({x:d,y:g,pressure:M=.5})=>[d,g,M]);if(l.length===2){let d=l[1];l=l.slice(0,-1);for(let g=1;g<5;g++)l.push(me(l[0],d,g/4))}l.length===1&&(l=[...l,[...x(l[0],[1,1]),...l[0].slice(2)]]);let h=[{point:[l[0][0],l[0][1]],pressure:l[0][2]>=0?l[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],u=!1,j=0,a=h[0],b=l.length-1;for(let d=1;d<l.length;d++){let g=r&&d===b?l[d].slice(0,2):me(a.point,l[d],i);if(st(a.point,g))continue;let M=lt(g,a.point);if(j+=M,d<b&&!u){if(j<s)continue;u=!0}a={point:g,pressure:l[d][2]>=0?l[d][2]:.5,vector:Xe(C(a.point,g)),distance:M,runningLength:j},h.push(a)}return h[0].vector=((o=h[1])==null?void 0:o.vector)||[0,0],h}function dt(e,t={}){return ct(ut(e,t),t)}var ht=dt;const ft=e=>{if(!e){console.error("makeAllObjCanvasUnselectable: canvas is null");return}e.discardActiveObject(),e.selection=!1,e.forEachObject(t=>{t.setOptions({evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1})}),e.renderAll()};let q="",G=!1,ge=[[0,0]];const gt=({canvas:e,drawingSettings:t})=>{if(!e){console.error("drawStrokeOnCanvas: canvas is null");return}e.on("mouse:down",o=>{G=!0,q=V();const n=e.getPointer(o.e);ge=[[n.x,n.y]]}),e.on("mouse:move",o=>{if(!G)return;e.discardActiveObject();const n=e.getPointer(o.e);ge.push([n.x,n.y]);const s=ht(ge,{size:t.size,thinning:t.thinning,smoothing:t.smoothing,streamline:t.streamline,easing(u){return u=Math.max(0,Math.min(1,u)),u*u*(3-2*u)}}),r=tt(s),l=e.getObjects().filter(u=>(u==null?void 0:u.id)===q);if(l.length>0)for(let u=0;u<l.length;u++)e.remove(l[u]);const h=new D.fabric.Path(r,{scaleX:1,scaleY:1,cornerSize:6,evented:!1,selectable:!1,hasRotatingPoint:!1,fill:t.stroke});h.id=q,e.add(h)}),e.on("mouse:up",o=>{if(!G)return;const s=e.getObjects().filter(r=>(r==null?void 0:r.id)===q);for(let r=0;r<s.length;r++){const i=s[r];e.remove(i),i.setCoords(),e.add(i)}q="",G=!1})},pt=(e,t)=>{if(e)return setTimeout(()=>e.requestRenderAll(),t)},bt=({canvas:e,backgroundColor:t})=>{e&&e.setBackgroundColor(t,()=>pt(e,0))};let J=0,ee=0,pe=!1;const mt=({canvas:e})=>{e&&(e.on("mouse:down",t=>{var o,n,s;if(pe=!0,t&&t.e&&t.e.type==="touchstart"){const r=t.e;J=(o=r==null?void 0:r.changedTouches[0])==null?void 0:o.clientX,ee=(n=r==null?void 0:r.changedTouches[0])==null?void 0:n.clientY}(s=t.target)==null||s.setOptions({opacity:.5})}),e.on("mouse:move",t=>{if(!(!pe||!t||!t.e||t.target)){if(t.e.type==="mousemove"){const o=new D.fabric.Point(t.e.movementX,t.e.movementY);e.relativePan(o)}if(t.e.type==="touchmove"){const o=t.e,n=o==null?void 0:o.touches[0];if(!n)return;const s=.9;let r=(n.clientX-J)*s,i=(n.clientY-ee)*s;J=n.clientX,ee=n.clientY;const l=new D.fabric.Point(r,i);e.relativePan(l)}}}),e.on("mouse:up",t=>{var o;pe=!1,(o=t.target)==null||o.setOptions({opacity:1}),J=0,ee=0}))};let te="",ne=!1;const wt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{ne=!0,te=V();const n=e.getPointer(o.e),s=[n.x,n.y,n.x,n.y],r=new D.fabric.Line(s,{cornerSize:6,strokeWidth:3,cornerStyle:"circle",fill:t.stroke,stroke:t.stroke,originX:"center",originY:"center",evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1});r.id=te,e.add(r)}),e.on("mouse:move",o=>{if(!ne)return;const n=e.getPointer(o.e),r=e.getObjects().filter(i=>(i==null?void 0:i.id)===te);for(let i=0;i<r.length;i++){const l=r[i];l==null||l.setOptions({x2:n.x,y2:n.y})}e.renderAll()}),e.on("mouse:up",()=>{if(!ne)return;ne=!1;const n=e.getObjects().filter(s=>(s==null?void 0:s.id)===te);for(let s=0;s<n.length;s++){const r=n[s];e.remove(r),r.setCoords(),e.add(r)}}))},yt=e=>{var o;const t=(o=e.transform)==null?void 0:o.target;if(t){const n=t.scaleX||1,s=t.scaleY||1,r=t.width||1,i=t.height||1,l=r*n,h=i*s;t.set({width:l,height:h,scaleX:1,scaleY:1}),t.setCoords()}},Mt=He();let oe="",F=0,Z=0,be=!1;const Ct=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{be=!0;const n=e.getPointer(o.e);F=n.x,Z=n.y;const s=new D.fabric.Rect({angle:0,top:Z,left:F,evented:!1,originY:"top",originX:"left",selectable:!1,noScaleCache:!1,hasRotatingPoint:!1,width:n.x-F,height:n.y-Z,rx:t.rx,ry:t.ry,cornerSize:6,stroke:t.stroke,strokeWidth:t.strokeWidth,fill:Ue({pasterns:Mt,stroke:t.stroke,background:t.background})});s.on("scaling",r=>yt(r)),s.id=V(),oe=s.id,e.add(s).renderAll()}),e.on("mouse:move",o=>{if(!be||!oe)return;const n=e.getPointer(o.e),r=e.getObjects().find(i=>i.id===oe);r&&(F>n.x&&r.set({left:Math.abs(n.x)}),Z>n.y&&r.set({top:Math.abs(n.y)}),r.setOptions({width:Math.abs(F-n.x),height:Math.abs(Z-n.y)}),e.renderAll())}),e.on("mouse:up",o=>{be=!1;const s=e.getObjects().find(r=>r.id===oe);s&&(e.remove(s),s.setOptions({evented:!0,selectable:!0,hasRotatingPoint:!0}),s.setCoords(),e.add(s),e.setActiveObject(s))}))},Ae=e=>e==="drawing"||e==="panning"||e==="line"||e==="arrow",kt=e=>{if(!e){console.error("makeAllObjCanvasSelectable: canvas is null");return}e.selection=!0,e.forEachObject(t=>{t.setOptions({evented:!0,selectable:!0,hasControls:!0,hasRotatingPoint:!0})}),e.renderAll()},De=e=>{e==null||e.off("mouse:up"),e==null||e.off("mouse:down"),e==null||e.off("mouse:move")};let se="",_=0,v=0,L=0,X=0,re=!1;const w=5,xt=({canvas:e,squareModeSettings:t})=>{e&&(e.on("mouse:down",o=>{re=!0,se=V();const n=e.getPointer(o.e),s=[n.x,n.y,n.x,n.y];L=n.x,X=n.y;const r=new D.fabric.Line(s,{cornerSize:6,strokeWidth:3,originX:"center",originY:"center",cornerStyle:"circle",fill:t.stroke,stroke:t.stroke,evented:!1,selectable:!1,hasControls:!1,hasRotatingPoint:!1});r.id=se,e.add(r)}),e.on("mouse:move",o=>{if(!re)return;const n=e.getPointer(o.e),r=e.getObjects().filter(i=>(i==null?void 0:i.id)===se);for(let i=0;i<r.length;i++){const l=r[i];l==null||l.setOptions({x2:n.x,y2:n.y})}e.renderAll()}),e.on("mouse:up",o=>{if(!re)return;re=!1;const n=e.getPointer(o.e);if(_=n.x,v=n.y,L===_&&X===v)return;const s=Math.atan2(v-X,_-L);_=_-w*Math.cos(s),v=v-w*Math.sin(s);const r=[{x:L,y:X},{x:L-w/4*Math.cos(s-Math.PI/2),y:X-w/4*Math.sin(s-Math.PI/2)},{x:_-w/4*Math.cos(s-Math.PI/2),y:v-w/4*Math.sin(s-Math.PI/2)},{x:_-w*Math.cos(s-Math.PI/2),y:v-w*Math.sin(s-Math.PI/2)},{x:_+w*2*Math.cos(s),y:v+w*2*Math.sin(s)},{x:_-w*Math.cos(s+Math.PI/2),y:v-w*Math.sin(s+Math.PI/2)},{x:_-w/4*Math.cos(s+Math.PI/2),y:v-w/4*Math.sin(s+Math.PI/2)},{x:L-w/4*Math.cos(s+Math.PI/2),y:X-w/4*Math.sin(s+Math.PI/2)},{x:L,y:X}],i=new D.fabric.Polyline(r,{opacity:1,cornerSize:6,evented:!0,selectable:!0,hasControls:!0,objectCaching:!1,hasRotatingPoint:!0,fill:t.stroke}),l=V();i.id=l,e.add(i),e.forEachObject(h=>{const u=h;u.id===se&&e.remove(u),u.id===l&&(e.remove(u),u.setCoords(),e.add(u),e.setActiveObject(u))}),e.renderAll()}))},jt=we({__name:"MainCanvas",setup(e){const t=$e(),o=qe(),n=W(null),{addListener:s,removeListener:r}=Je(a=>{const b=o.getSelectedCanvas;b&&et(a,b)}),i=a=>{var d,g;if(console.log("double click",a),a.target&&a.target.type==="i-text"){a.target.enterEditing(),r();return}const b={y:((d=a.pointer)==null?void 0:d.y)||0,x:(((g=a.pointer)==null?void 0:g.x)||0)-100};Ze({position:b,text:"Double click to edit text",canvas:o.getSelectedCanvas})},l=a=>{console.log("mouse down",a)},h=a=>{o.setSelectedCanvas({selectedCanvas:a})},u=a=>{console.log("selection",a),s(),t.setCanvasMode({canvasMode:"ObjContextMenu"})},j=a=>{t.setCanvasMode({canvasMode:"mainMenu"})};return Fe(()=>({getCanvasMode:t.getCanvasMode,getIsDotBackground:t.getIsDotBackground,getSelectedCanvas:o.getSelectedCanvas,getDrawingSettings:o.getDrawingSettings,getSquareModeSettings:o.getSquareModeSettings}),a=>{const{getCanvasMode:b,getSelectedCanvas:d,getDrawingSettings:g,getIsDotBackground:M,getSquareModeSettings:P}=a;switch(De(d),Ae(b)&&(console.log("unselectable"),ft(d)),Ae(b)||(console.log("selectable"),kt(d)),t.getCanvasMode){case"drawing":gt({canvas:d,drawingSettings:g});break;case"panning":mt({canvas:d});break;case"square":Ct({canvas:d,squareModeSettings:P});break;case"line":wt({canvas:d,squareModeSettings:P});break;case"arrow":xt({canvas:d,squareModeSettings:P});break;default:De(d);break}bt({canvas:d,backgroundColor:M?Ve({}):"transparent"})}),(a,b)=>(ye(),Me("div",{class:"design-canvas-container",ref_key:"elRef",ref:n},[Le(Ge,{id:"1",onMouseDown:l,onMouseDblclick:i,onCanvasCreated:h,onSelectionCreated:u,onSelectionUpdated:u,onSelectionCleared:j})],512))}});const _t=Ye(jt,[["__scopeId","data-v-13beea1f"]]),Pt=we({__name:"DesignView",setup(e){return(t,o)=>(ye(),Me("main",null,[Le(_t)]))}});export{Pt as default};
